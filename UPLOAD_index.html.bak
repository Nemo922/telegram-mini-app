// Telegram Web App API
const tg = window.Telegram.WebApp;
tg.expand();

// Loading screen
window.addEventListener('load', () => {
    setTimeout(() => {
        document.getElementById('loadingScreen').style.display = 'none';
        
        // Check if user is registered
        if (checkUserProfile()) {
            document.getElementById('app').style.display = 'flex';
        }
        // If not registered, showRegistrationForm() is called in checkUserProfile()
    }, 2000);
});

// Game State
let gameState = {
    points: 0,
    referrals: 0,
    completedTasks: [],
    myAccounts: [],
    purchasedAccounts: [],
    favorites: [],
    notifications: [],
    isAdmin: false,
    adminId: null,
    language: 'tr' // tr veya en
};

// Load saved data
function loadGame() {
    try {
        const saved = localStorage.getItem('pubgMarketplace');
        if (saved) {
            gameState = { ...gameState, ...JSON.parse(saved) };
        }
    } catch (e) {
        console.warn('Error loading game state:', e);
    }
}

// Save game data
function saveGame() {
    try {
        localStorage.setItem('pubgMarketplace', JSON.stringify(gameState));
    } catch (e) {
        console.warn('Error saving game state:', e);
    }
}

// User info
const usernameElement = document.getElementById('username');
let currentUserId = null;
let currentUsername = null;

// Safe localStorage access
function getFromStorage(key, defaultValue = null) {
    try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
    } catch (e) {
        console.warn(`Storage error for ${key}:`, e);
        return defaultValue;
    }
}

function saveToStorage(key, value) {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    } catch (e) {
        console.warn(`Storage error for ${key}:`, e);
        return false;
    }
}

let userProfile = getFromStorage('userProfile', null);

if (tg.initDataUnsafe.user) {
    const user = tg.initDataUnsafe.user;
    currentUserId = user.id;
    currentUsername = user.username || user.first_name;
    
    // Admin kontrolÃ¼ - Telegram ID'ni buraya yaz
    const ADMIN_ID = 123456789; // BURAYA KENDÄ° TELEGRAM ID'NI YAZ
    gameState.isAdmin = (currentUserId === ADMIN_ID);
    gameState.adminId = ADMIN_ID;
} else {
    // Test iÃ§in
    currentUserId = 999999;
    currentUsername = 'TestUser';
    gameState.isAdmin = true;
}

// Check if user profile exists
function checkUserProfile() {
    if (!userProfile) {
        showRegistrationForm();
        return false;
    }
    usernameElement.textContent = userProfile.firstName;
    return true;
}

// Login Form
function showLoginForm() {
    const modal = `
        <div class="modal" id="loginModal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>ğŸ” GiriÅŸ Yap</h2>
                <p style="color: #8b8d98; margin-bottom: 20px;">Telegram ID'nle giriÅŸ yap</p>
                
                <input type="text" id="loginTelegramId" class="input-field" placeholder="Telegram ID'ni gir (Ã¶rn: 123456789)" maxlength="20">
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" onclick="performLogin()">GiriÅŸ Yap</button>
                    <button class="btn-secondary" onclick="closeModal('loginModal')">Ä°ptal</button>
                </div>
                
                <p style="text-align: center; color: #8b8d98; font-size: 12px; margin-top: 16px;">
                    Telegram ID'ni bulmak iÃ§in @userinfobot'u aÃ§
                </p>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
    document.getElementById('loginTelegramId').focus();
}

function performLogin() {
    const telegramId = document.getElementById('loginTelegramId').value.trim();
    
    if (!telegramId || !/^\d+$/.test(telegramId)) {
        alert('âŒ LÃ¼tfen geÃ§erli bir Telegram ID gir!');
        return;
    }
    
    try {
        // Telegram ID'yi currentUserId olarak kaydet
        currentUserId = parseInt(telegramId);
        localStorage.setItem('currentUserId', currentUserId);
        
        // TÃ¼m kullanÄ±cÄ±lardan bul
        let allUsers = JSON.parse(localStorage.getItem('allUsers') || '{}');
        
        if (allUsers[currentUserId]) {
            userProfile = allUsers[currentUserId];
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            const oldForm = document.querySelector('.registration-overlay');
            if (oldForm) oldForm.remove();
            
            document.getElementById('app').style.display = 'flex';
            renderProfile();
            addNotification(`ğŸ‘‹ HoÅŸ geldin, ${userProfile.firstName}!`);
        } else {
            alert('âŒ Bu Telegram ID ile kayÄ±tlÄ± hesap bulunamadÄ±. LÃ¼tfen hesap oluÅŸtur.');
        }
    } catch (e) {
        console.error('Login error:', e);
        alert('âŒ GiriÅŸ sÄ±rasÄ±nda hata oluÅŸtu. LÃ¼tfen tekrar dene.');
    }
}

function showRegistrationForm() {
    const registrationHTML = `
        <div class="registration-overlay">
            <div class="registration-container">
                <div class="registration-header">
                    <div class="registration-logo">ğŸ®</div>
                    <h1>PUBG Market'e HoÅŸ Geldin!</h1>
                    <p>BaÅŸlamak iÃ§in bir seÃ§enek seÃ§</p>
                </div>
                
                <div class="registration-form" style="text-align: center;">
                    <button class="btn-register" onclick="showLoginPanel()" style="margin-bottom: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        ğŸ” GiriÅŸ Yap
                    </button>
                    <button class="btn-register" onclick="showSignupPanel()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        âœ… Hesap OluÅŸtur
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', registrationHTML);
}

function showLoginPanel() {
    const loginHTML = `
        <div class="registration-overlay">
            <div class="registration-container">
                <div class="registration-header">
                    <div class="registration-logo">ğŸ”</div>
                    <h1>GiriÅŸ Yap</h1>
                    <p>Telegram ID'nle giriÅŸ yap</p>
                </div>
                
                <div class="registration-form">
                    <div class="form-group">
                        <label class="form-label">ğŸ“± Telegram ID</label>
                        <input type="text" id="loginTelegramId" class="form-input" placeholder="Telegram ID'ni gir (Ã¶rn: 123456789)" maxlength="20">
                        <small class="form-hint">@userinfobot'u aÃ§arak ID'ni Ã¶ÄŸrenebilirsin</small>
                    </div>
                    
                    <button class="btn-register" onclick="performLogin()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        ğŸ” GiriÅŸ Yap
                    </button>
                    
                    <button class="btn-register" onclick="showRegistrationForm()" style="background: linear-gradient(135deg, #999 0%, #666 100%); margin-top: 12px;">
                        â† Geri DÃ¶n
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Eski formu kaldÄ±r
    const oldForm = document.querySelector('.registration-overlay');
    if (oldForm) oldForm.remove();
    
    document.body.insertAdjacentHTML('beforeend', loginHTML);
    document.getElementById('loginTelegramId').focus();
}

function showSignupPanel() {
    const signupHTML = `
        <div class="registration-overlay">
            <div class="registration-container">
                <div class="registration-header">
                    <div class="registration-logo">âœ…</div>
                    <h1>Hesap OluÅŸtur</h1>
                    <p>Bilgilerini girerek hesabÄ±nÄ± oluÅŸtur</p>
                </div>
                
                <div class="registration-form">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ Ad</label>
                        <input type="text" id="regFirstName" class="form-input" placeholder="AdÄ±nÄ± gir" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ Soyad <span style="opacity: 0.5; font-size: 12px;">(Ä°steÄŸe baÄŸlÄ±)</span></label>
                        <input type="text" id="regLastName" class="form-input" placeholder="SoyadÄ±nÄ± gir (opsiyonel)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ†” Telegram ID</label>
                        <input type="text" id="regTelegramId" class="form-input" placeholder="Telegram ID'ni gir (Ã¶rn: 123456789)" maxlength="20" required>
                        <small class="form-hint">
                            ğŸ“± ID'ni Ã¶ÄŸrenmek iÃ§in: Telegram'da <strong>@userinfobot</strong>'u aÃ§ ve mesaj gÃ¶nder. Bot sana ID'ni gÃ¶nderecek.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ“± Telegram KullanÄ±cÄ± AdÄ±</label>
                        <div class="telegram-input-wrapper">
                            <span class="telegram-prefix">@</span>
                            <input type="text" id="regTelegram" class="form-input telegram-input" placeholder="kullaniciadi" required>
                        </div>
                        <small class="form-hint">Telegram kullanÄ±cÄ± adÄ±nÄ± @ iÅŸareti olmadan gir</small>
                    </div>
                    
                    <div class="form-checkbox">
                        <input type="checkbox" id="regTerms" required>
                        <label for="regTerms">
                            <a href="#" onclick="showTerms(); return false;">KullanÄ±m KoÅŸullarÄ±</a>'nÄ± ve 
                            <a href="#" onclick="showPrivacy(); return false;">Gizlilik PolitikasÄ±</a>'nÄ± okudum, kabul ediyorum
                        </label>
                    </div>
                    
                    <button class="btn-register" onclick="completeRegistration()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        âœ… HesabÄ± OluÅŸtur
                    </button>
                    
                    <button class="btn-register" onclick="showRegistrationForm()" style="background: linear-gradient(135deg, #999 0%, #666 100%); margin-top: 12px;">
                        â† Geri DÃ¶n
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Eski formu kaldÄ±r
    const oldForm = document.querySelector('.registration-overlay');
    if (oldForm) oldForm.remove();
    
    document.body.insertAdjacentHTML('beforeend', signupHTML);
}

function completeRegistration() {
    const firstName = document.getElementById('regFirstName').value.trim();
    const lastName = document.getElementById('regLastName').value.trim();
    const telegramId = document.getElementById('regTelegramId').value.trim();
    const telegram = document.getElementById('regTelegram').value.trim().replace('@', '');
    const terms = document.getElementById('regTerms').checked;
    
    // Validation
    if (!firstName || firstName.length < 2) {
        alert('âŒ LÃ¼tfen geÃ§erli bir ad gir (en az 2 karakter)');
        return;
    }
    
    if (lastName && lastName.length < 2) {
        alert('âŒ Soyad en az 2 karakter olmalÄ±');
        return;
    }
    
    if (!telegramId || !/^\d+$/.test(telegramId)) {
        alert('âŒ LÃ¼tfen geÃ§erli bir Telegram ID gir (sadece rakamlar)');
        return;
    }
    
    if (!telegram || telegram.length < 3) {
        alert('âŒ LÃ¼tfen geÃ§erli bir Telegram kullanÄ±cÄ± adÄ± gir (en az 3 karakter)');
        return;
    }
    
    if (!terms) {
        alert('âŒ Devam etmek iÃ§in kullanÄ±m koÅŸullarÄ±nÄ± kabul etmelisin');
        return;
    }
    
    try {
        // Save user profile
        const fullName = lastName ? `${firstName} ${lastName}` : firstName;
        
        // Set currentUserId from Telegram ID
        currentUserId = parseInt(telegramId);
        localStorage.setItem('currentUserId', currentUserId);
        
        userProfile = {
            userId: currentUserId,
            firstName: firstName,
            lastName: lastName || '',
            fullName: fullName,
            telegram: telegram,
            telegramId: parseInt(telegramId),
            registeredAt: Date.now(),
            verified: false
        };
        
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        
        // TÃ¼m kullanÄ±cÄ±larÄ± kaydet (multi-user support) - KRITIK!
        let allUsers = JSON.parse(localStorage.getItem('allUsers') || '{}');
        allUsers[currentUserId] = userProfile;
        localStorage.setItem('allUsers', JSON.stringify(allUsers));
        
        console.log('âœ… User saved to allUsers:', allUsers);
        
        currentUsername = telegram;
        
        // Save to Firebase
        if (typeof saveUserToFirebase === 'function') {
            saveUserToFirebase(userProfile).then(success => {
                if (success) {
                    console.log('âœ… User synced to Firebase');
                }
            });
        }
        
        // Update UI
        usernameElement.textContent = firstName;
        
        // Remove registration form
        const oldForm = document.querySelector('.registration-overlay');
        if (oldForm) oldForm.remove();
        
        // Show welcome notification
        addNotification(`ğŸ‰ HoÅŸ geldin ${firstName}! HesabÄ±n baÅŸarÄ±yla oluÅŸturuldu.`);
        
        // Show app
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
    } catch (e) {
        console.error('Registration error:', e);
        alert('âŒ KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu. LÃ¼tfen tekrar dene.');
    }
}

function showTerms() {
    const modal = `
        <div class="modal" id="termsModal">
            <div class="modal-content">
                <h2>ğŸ“œ KullanÄ±m KoÅŸullarÄ±</h2>
                <div class="terms-content">
                    <h3>1. Genel Kurallar</h3>
                    <p>PUBG Market platformunu kullanarak aÅŸaÄŸÄ±daki kurallara uymayÄ± kabul edersiniz:</p>
                    <ul>
                        <li>Sahte veya yanÄ±ltÄ±cÄ± ilan yayÄ±nlamayacaksÄ±nÄ±z</li>
                        <li>BaÅŸkalarÄ±nÄ±n hesaplarÄ±nÄ± izinsiz satmayacaksÄ±nÄ±z</li>
                        <li>Platform Ã¼zerinden dolandÄ±rÄ±cÄ±lÄ±k yapmayacaksÄ±nÄ±z</li>
                    </ul>
                    
                    <h3>2. Hesap GÃ¼venliÄŸi</h3>
                    <p>Hesap bilgilerinizi gÃ¼vende tutmak sizin sorumluluÄŸunuzdadÄ±r.</p>
                    
                    <h3>3. Ä°ÅŸlemler</h3>
                    <p>AlÄ±cÄ± ve satÄ±cÄ± arasÄ±ndaki iÅŸlemler kendi sorumluluklarÄ±ndadÄ±r.</p>
                </div>
                <button class="btn-primary" onclick="closeModal('termsModal')">Kapat</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function showPrivacy() {
    const modal = `
        <div class="modal" id="privacyModal">
            <div class="modal-content">
                <h2>ğŸ”’ Gizlilik PolitikasÄ±</h2>
                <div class="terms-content">
                    <h3>Toplanan Bilgiler</h3>
                    <p>Platformumuz aÅŸaÄŸÄ±daki bilgileri toplar:</p>
                    <ul>
                        <li>Ad ve Soyad</li>
                        <li>Telegram kullanÄ±cÄ± adÄ±</li>
                        <li>Ä°lan bilgileri</li>
                    </ul>
                    
                    <h3>Bilgilerin KullanÄ±mÄ±</h3>
                    <p>Bilgileriniz sadece platform iÃ§inde kullanÄ±lÄ±r ve Ã¼Ã§Ã¼ncÃ¼ ÅŸahÄ±slarla paylaÅŸÄ±lmaz.</p>
                    
                    <h3>Veri GÃ¼venliÄŸi</h3>
                    <p>Verileriniz tarayÄ±cÄ±nÄ±zda gÃ¼venli bir ÅŸekilde saklanÄ±r.</p>
                </div>
                <button class="btn-primary" onclick="closeModal('privacyModal')">Kapat</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

// PUBG Accounts
let accounts = [
    {
        id: 1,
        seller: 'Admin',
        sellerId: 123456789,
        sellerUsername: 'admin',
        level: 85,
        tier: 'Conqueror',
        uc: 15000,
        skins: 250,
        price: 500,
        priceType: 'TL',
        image: 'ğŸ†',
        description: 'Full eÅŸya, tÃ¼m sezon royale pass',
        featured: true,
        createdAt: Date.now(),
        views: 0,
        verified: true,
        images: []
    },
    {
        id: 2,
        seller: 'TestUser',
        sellerId: 999999,
        sellerUsername: 'TestUser',
        level: 72,
        tier: 'Ace',
        uc: 8000,
        skins: 180,
        price: 300,
        priceType: 'TL',
        image: 'â­',
        description: 'Ã‡ok sayÄ±da mythic skin',
        featured: false,
        createdAt: Date.now(),
        views: 0,
        verified: false,
        images: []
    },
    {
        id: 3,
        seller: 'TestUser',
        sellerId: 999999,
        sellerUsername: 'TestUser',
        level: 50,
        tier: 'Crown',
        uc: 5000,
        skins: 100,
        price: 5000,
        priceType: 'Puan',
        image: 'ğŸ',
        description: 'Hediye hesap - gÃ¶revlerle kazan!',
        featured: false,
        isGift: true,
        createdAt: Date.now(),
        views: 0,
        verified: false,
        images: []
    }
];

// Load accounts from localStorage
function loadAccounts() {
    const saved = localStorage.getItem('allAccounts');
    if (saved) {
        accounts = JSON.parse(saved);
    }
}

function saveAccounts() {
    localStorage.setItem('allAccounts', JSON.stringify(accounts));
}

loadAccounts();

// Favorites System
function toggleFavorite(accountId) {
    const index = gameState.favorites.indexOf(accountId);
    if (index > -1) {
        gameState.favorites.splice(index, 1);
        addNotification('âŒ Favorilerden kaldÄ±rÄ±ldÄ±');
    } else {
        gameState.favorites.push(accountId);
        addNotification('â­ Favorilere eklendi');
    }
    saveGame();
    renderAccounts();
}

function isFavorite(accountId) {
    return gameState.favorites.includes(accountId);
}

// Notification System
function addNotification(message, type = 'info') {
    const notification = {
        id: Date.now(),
        message,
        type,
        timestamp: Date.now(),
        read: false
    };
    gameState.notifications.unshift(notification);
    if (gameState.notifications.length > 50) {
        gameState.notifications = gameState.notifications.slice(0, 50);
    }
    saveGame();
    showNotificationToast(message);
    updateNotificationBadge();
}

function showNotificationToast(message) {
    const toast = document.createElement('div');
    toast.className = 'notification-toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function updateNotificationBadge() {
    const unreadCount = gameState.notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationBadge');
    if (badge) {
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? 'block' : 'none';
    }
}

// View Counter
function incrementViews(accountId) {
    const account = accounts.find(a => a.id === accountId);
    if (account) {
        account.views = (account.views || 0) + 1;
        saveAccounts();
    }
}

// Offer System
function makeOffer(accountId) {
    const account = accounts.find(a => a.id === accountId);
    if (!account) return;
    
    const offerPrice = prompt(`Teklif fiyatÄ±nÄ± gir (Orijinal: ${account.price} ${account.priceType}):`);
    if (offerPrice && !isNaN(offerPrice)) {
        addNotification(`ğŸ’° ${account.tier} hesabÄ± iÃ§in ${offerPrice} ${account.priceType} teklif edildi`);
        alert(`Teklifin satÄ±cÄ±ya iletildi! @${account.sellerUsername} seninle iletiÅŸime geÃ§ecek.`);
    }
}

// Search & Filter System
let filters = {
    search: '',
    category: '',
    minPrice: null,
    maxPrice: null,
    minLevel: null,
    maxLevel: null,
    tier: '',
    sort: 'newest'
};

function filterAndSortAccounts() {
    let filtered = [...accounts];
    
    if (filters.search) {
        filtered = filtered.filter(acc => 
            acc.description.toLowerCase().includes(filters.search) ||
            acc.tier.toLowerCase().includes(filters.search) ||
            acc.seller.toLowerCase().includes(filters.search)
        );
    }
    
    if (filters.category) {
        if (filters.category === 'sale') {
            filtered = filtered.filter(acc => !acc.isGift);
        } else if (filters.category === 'gift') {
            filtered = filtered.filter(acc => acc.isGift);
        } else if (filters.category === 'verified') {
            filtered = filtered.filter(acc => acc.verified);
        }
    }
    
    if (filters.minPrice !== null) {
        filtered = filtered.filter(acc => acc.price >= filters.minPrice);
    }
    if (filters.maxPrice !== null) {
        filtered = filtered.filter(acc => acc.price <= filters.maxPrice);
    }
    
    if (filters.minLevel !== null) {
        filtered = filtered.filter(acc => acc.level >= filters.minLevel);
    }
    if (filters.maxLevel !== null) {
        filtered = filtered.filter(acc => acc.level <= filters.maxLevel);
    }
    
    if (filters.tier) {
        filtered = filtered.filter(acc => acc.tier === filters.tier);
    }
    
    switch(filters.sort) {
        case 'newest':
            filtered.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            break;
        case 'price-low':
            filtered.sort((a, b) => a.price - b.price);
            break;
        case 'price-high':
            filtered.sort((a, b) => b.price - a.price);
            break;
        case 'level-high':
            filtered.sort((a, b) => b.level - a.level);
            break;
        case 'popular':
            filtered.sort((a, b) => (b.views || 0) - (a.views || 0));
            break;
    }
    
    return filtered;
}

// Initialize
loadGame();

// Update UI
function updateUI() {
    document.getElementById('points').textContent = gameState.points.toLocaleString();
    renderAccounts();
}

updateUI();

// Buy Account
function buyAccount(accountId) {
    const account = accounts.find(a => a.id === accountId);
    if (!account) return;
    
    if (account.priceType === 'Puan') {
        if (gameState.points >= account.price) {
            if (confirm(`${account.price} puan harcayarak bu hesabÄ± almak istiyor musun?`)) {
                gameState.points -= account.price;
                gameState.purchasedAccounts.push(account);
                alert('Tebrikler! Hesap bilgileri mesajlarÄ±na gÃ¶nderildi.');
                updateUI();
                saveGame();
            }
        } else {
            alert(`Yeterli puanÄ±n yok! ${account.price - gameState.points} puan daha gerekli.`);
        }
    } else {
        alert('Ã–deme iÃ§in satÄ±cÄ±yla iletiÅŸime geÃ§ilecek...');
    }
}

// Tasks
const tasks = [
    { id: 1, icon: 'ğŸ“±', title: 'Telegram KanalÄ±na KatÄ±l', reward: 1000, link: 'https://t.me/yourchannel', enabled: true },
    { id: 2, icon: 'ğŸ¥', title: 'YouTube KanalÄ±na Abone Ol', reward: 800, link: 'https://youtube.com', enabled: true },
    { id: 3, icon: 'ğŸ¦', title: 'Twitter\'da Takip Et', reward: 500, link: 'https://twitter.com', enabled: true },
    { id: 4, icon: 'ğŸ“¸', title: 'Instagram\'da Takip Et', reward: 500, link: 'https://instagram.com', enabled: true },
    { id: 5, icon: 'â­', title: 'GÃ¼nlÃ¼k GiriÅŸ Bonusu', reward: 200, daily: true, enabled: true },
    { id: 6, icon: 'ğŸ‘¥', title: '5 ArkadaÅŸ Davet Et', reward: 2500, referralRequired: 5, enabled: true }
];

function saveTasksToStorage() {
    localStorage.setItem('adminTasks', JSON.stringify(tasks));
}

function loadTasksFromStorage() {
    const saved = localStorage.getItem('adminTasks');
    if (saved) {
        const savedTasks = JSON.parse(saved);
        savedTasks.forEach((savedTask, index) => {
            if (tasks[index]) {
                tasks[index] = { ...tasks[index], ...savedTask };
            }
        });
    }
}

loadTasksFromStorage();

function renderTasks() {
    const tasksList = document.getElementById('tasksList');
    const enabledTasks = tasks.filter(t => t.enabled);
    
    tasksList.innerHTML = `
        <div class="points-display">
            <div class="points-big">ğŸ ${gameState.points}</div>
            <div class="points-label">Toplam PuanÄ±n</div>
        </div>
        ${gameState.isAdmin ? '<button class="btn-primary" onclick="showAdminTaskPanel()" style="margin-bottom: 20px;">âš™ï¸ GÃ¶revleri YÃ¶net</button>' : ''}
    ` + enabledTasks.map(task => {
        const completed = gameState.completedTasks.includes(task.id);
        const canComplete = task.referralRequired ? gameState.referrals >= task.referralRequired : true;
        return `
            <div class="task-card">
                <div class="task-icon">${task.icon}</div>
                <div class="task-info">
                    <div class="task-title">${task.title}</div>
                    <div class="task-reward">+${task.reward.toLocaleString()} puan</div>
                </div>
                <button class="task-btn ${completed ? 'completed' : ''}" 
                        onclick="completeTask(${task.id})"
                        ${completed || !canComplete ? 'disabled' : ''}>
                    ${completed ? 'âœ“ TamamlandÄ±' : 'BaÅŸla'}
                </button>
            </div>
        `;
    }).join('');
}

function completeTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task || gameState.completedTasks.includes(taskId)) return;
    
    if (task.link) {
        window.open(task.link, '_blank');
    }
    
    setTimeout(() => {
        gameState.points += task.reward;
        gameState.completedTasks.push(taskId);
        alert(`Tebrikler! ${task.reward} puan kazandÄ±n!`);
        updateUI();
        saveGame();
        renderTasks();
    }, 2000);
}

// My Accounts
function renderMyAccounts() {
    const myAccountsList = document.getElementById('myAccountsList');
    
    // Admin ise tÃ¼m ilanlarÄ±, deÄŸilse sadece kendi ilanlarÄ±nÄ± gÃ¶ster
    const myOwnAccounts = gameState.isAdmin 
        ? accounts 
        : accounts.filter(a => a.sellerId === currentUserId);
    
    const myAccountsHTML = myOwnAccounts.length > 0 ? `
        ${gameState.isAdmin ? '<h3 style="margin: 20px 0 10px 0;">TÃ¼m Ä°lanlar (Admin)</h3>' : '<h3 style="margin: 20px 0 10px 0;">SatÄ±ÅŸa Ã‡Ä±kardÄ±ÄŸÄ±n Hesaplar</h3>'}
        ${myOwnAccounts.map(acc => {
            const isOwner = acc.sellerId === currentUserId;
            return `
            <div class="my-account-card ${!isOwner ? 'other-user' : ''}">
                <div class="account-info">
                    <div><strong>Seviye ${acc.level}</strong> - ${acc.tier}</div>
                    <div>ğŸ’ ${acc.uc} UC | ğŸ‘• ${acc.skins} Skin | ğŸ‘ï¸ ${acc.views || 0}</div>
                    <div class="account-price">${acc.price} ${acc.priceType}</div>
                    ${!isOwner ? `<div style="font-size: 11px; opacity: 0.6; margin-top: 4px;">SatÄ±cÄ±: @${acc.sellerUsername}</div>` : ''}
                </div>
                <div class="my-account-actions">
                    <button class="btn-edit" onclick="editAccount(${acc.id})">âœï¸</button>
                    <button class="btn-feature" onclick="toggleFeaturedAccount(${acc.id})">${acc.featured ? 'â­' : 'â˜†'}</button>
                    <button class="btn-remove" onclick="deleteAccount(${acc.id})">ğŸ—‘ï¸</button>
                </div>
            </div>
        `}).join('')}
    ` : '';
    
    const purchasedHTML = gameState.purchasedAccounts.length > 0 ? `
        <h3 style="margin: 20px 0 10px 0;">SatÄ±n AldÄ±ÄŸÄ±n Hesaplar</h3>
        ${gameState.purchasedAccounts.map(acc => `
            <div class="my-account-card purchased">
                <div class="account-info">
                    <div><strong>Seviye ${acc.level}</strong> - ${acc.tier}</div>
                    <div>ğŸ’ ${acc.uc} UC | ğŸ‘• ${acc.skins} Skin</div>
                    <div style="font-size: 12px; opacity: 0.8;">SatÄ±cÄ±: @${acc.sellerUsername}</div>
                </div>
            </div>
        `).join('')}
    ` : '';
    
    if (myOwnAccounts.length === 0 && gameState.purchasedAccounts.length === 0) {
        myAccountsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“¦</div>
                <div class="empty-text">HenÃ¼z hesabÄ±n yok</div>
                <button class="btn-primary" onclick="showAddAccountModal()">
                    â• Hesap Ekle
                </button>
            </div>
        `;
    } else {
        myAccountsList.innerHTML = `
            <button class="btn-primary" onclick="showAddAccountModal()" style="margin-bottom: 20px;">
                â• Yeni Hesap Ekle
            </button>
            ${myAccountsHTML}
            ${purchasedHTML}
        `;
    }
}

// Add Account Modal
function showAddAccountModal() {
    const modal = `
        <div class="modal" id="addAccountModal">
            <div class="modal-content">
                <h2>â• Hesap Ekle</h2>
                <input type="number" id="accLevel" placeholder="Seviye (Ã¶rn: 75)" class="input-field">
                <input type="text" id="accTier" placeholder="Tier (Ã¶rn: Ace, Crown, Conqueror)" class="input-field">
                <input type="number" id="accUC" placeholder="UC MiktarÄ±" class="input-field">
                <input type="number" id="accSkins" placeholder="Skin SayÄ±sÄ±" class="input-field">
                <input type="number" id="accPrice" placeholder="Fiyat" class="input-field">
                <select id="accPriceType" class="input-field">
                    <option value="TL">TL</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
                <textarea id="accDesc" placeholder="AÃ§Ä±klama (Ã¶rn: Full eÅŸya, mythic skinler)" class="input-field"></textarea>
                
                <div class="image-upload-section">
                    <label class="image-upload-label">
                        ğŸ“· Ekran GÃ¶rÃ¼ntÃ¼leri Ekle (Maks 5)
                        <input type="file" id="accImages" accept="image/*" multiple class="image-upload-input" onchange="previewImages(event)">
                    </label>
                    <div class="image-preview-grid" id="imagePreviewGrid"></div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="addAccount()">Ekle</button>
                    <button class="btn-secondary" onclick="closeModal()">Ä°ptal</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

let selectedImages = [];

function previewImages(event) {
    const files = Array.from(event.target.files);
    const previewGrid = document.getElementById('imagePreviewGrid');
    
    if (files.length + selectedImages.length > 5) {
        alert('Maksimum 5 gÃ¶rsel ekleyebilirsin!');
        return;
    }
    
    files.forEach(file => {
        if (file.size > 2 * 1024 * 1024) {
            alert('GÃ¶rsel boyutu 2MB\'dan kÃ¼Ã§Ã¼k olmalÄ±!');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            selectedImages.push(e.target.result);
            renderImagePreviews();
        };
        reader.readAsDataURL(file);
    });
}

function renderImagePreviews() {
    const previewGrid = document.getElementById('imagePreviewGrid');
    if (!previewGrid) return;
    
    previewGrid.innerHTML = selectedImages.map((img, index) => `
        <div class="image-preview-item">
            <img src="${img}" alt="Preview ${index + 1}">
            <button class="image-remove-btn" onclick="removeImage(${index})">âœ•</button>
        </div>
    `).join('');
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    renderImagePreviews();
}

function addAccount() {
    const newAccount = {
        id: Date.now(),
        seller: currentUsername,
        sellerId: currentUserId,
        sellerUsername: currentUsername,
        level: parseInt(document.getElementById('accLevel').value),
        tier: document.getElementById('accTier').value,
        uc: parseInt(document.getElementById('accUC').value),
        skins: parseInt(document.getElementById('accSkins').value),
        price: parseInt(document.getElementById('accPrice').value),
        priceType: document.getElementById('accPriceType').value,
        description: document.getElementById('accDesc').value,
        image: 'ğŸ®',
        featured: false,
        createdAt: Date.now(),
        views: 0,
        verified: false,
        images: [...selectedImages]
    };
    
    if (!newAccount.level || !newAccount.tier || !newAccount.price) {
        alert('LÃ¼tfen tÃ¼m alanlarÄ± doldur!');
        return;
    }
    
    gameState.myAccounts.push(newAccount);
    accounts.push(newAccount);
    saveGame();
    saveAccounts();
    
    // Save to Firebase
    if (typeof saveAccountToFirebase === 'function') {
        saveAccountToFirebase(newAccount).then(success => {
            if (success) {
                console.log('âœ… Account synced to Firebase');
            }
        });
    }
    
    selectedImages = [];
    closeModal();
    renderMyAccounts();
    renderAccounts();
    addNotification('âœ… HesabÄ±n eklendi ve satÄ±ÅŸa Ã§Ä±karÄ±ldÄ±!');
}

function removeAccount(accountId) {
    gameState.myAccounts = gameState.myAccounts.filter(a => a.id !== accountId);
    accounts = accounts.filter(a => a.id !== accountId);
    saveGame();
    renderMyAccounts();
    renderAccounts();
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId || 'addAccountModal');
    if (modal) modal.remove();
}

// Friends/Referral
function renderFriends() {
    document.getElementById('totalReferrals').textContent = gameState.referrals;
    document.getElementById('referralEarnings').textContent = (gameState.referrals * 1000).toLocaleString();
}

document.getElementById('inviteBtn').addEventListener('click', () => {
    const botUsername = 'coindrop_game_bot'; // Bot username'inizi buraya
    const userId = tg.initDataUnsafe.user?.id || '123456';
    const inviteLink = `https://t.me/${botUsername}?start=ref_${userId}`;
    
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent('PUBG hesap al/sat! Bedava hesap kazan! ğŸ®')}`);
});

// Navigation
const navItems = document.querySelectorAll('.nav-item');
const pages = {
    home: document.querySelector('.main-content'),
    favorites: document.getElementById('favoritesPage'),
    tasks: document.getElementById('tasksPage'),
    myaccounts: document.getElementById('myaccountsPage'),
    friends: document.getElementById('friendsPage'),
    notifications: document.getElementById('notificationsPage'),
    stats: document.getElementById('statsPage'),
    profile: document.getElementById('profilePage')
};

navItems.forEach(item => {
    item.addEventListener('click', () => {
        const page = item.dataset.page;
        
        navItems.forEach(nav => nav.classList.remove('active'));
        item.classList.add('active');
        
        Object.keys(pages).forEach(key => {
            if (key === page) {
                pages[key].style.display = key === 'home' ? 'flex' : 'block';
            } else {
                pages[key].style.display = 'none';
            }
        });
        
        if (page === 'home') renderAccounts();
        if (page === 'favorites') renderFavorites();
        if (page === 'tasks') renderTasks();
        if (page === 'myaccounts') renderMyAccounts();
        if (page === 'friends') renderFriends();
    });
});

// Initial render
renderAccounts();
renderTasks();
renderMyAccounts();
renderFriends();


// Admin Task Management
function showAdminTaskPanel() {
    const modal = `
        <div class="modal admin-modal" id="adminTaskModal">
            <div class="admin-panel">
                <div class="admin-header">
                    <h2>âš™ï¸ GÃ¶rev YÃ¶netimi</h2>
                    <button class="close-btn" onclick="closeModal('adminTaskModal')">âœ•</button>
                </div>
                <div class="admin-content">
                    ${tasks.map(task => `
                        <div class="admin-card ${!task.enabled ? 'disabled' : ''}">
                            <div class="admin-card-header">
                                <div class="admin-card-icon">${task.icon}</div>
                                <div class="admin-card-info">
                                    <div class="admin-card-title">${task.title}</div>
                                    <div class="admin-card-subtitle">${task.reward} puan â€¢ ${task.link ? 'Link var' : 'Link yok'}</div>
                                </div>
                                <div class="admin-card-status">
                                    ${task.enabled ? '<span class="status-badge active">Aktif</span>' : '<span class="status-badge inactive">Pasif</span>'}
                                </div>
                            </div>
                            <div class="admin-card-actions">
                                <button class="action-btn edit" onclick="editTask(${task.id})" title="DÃ¼zenle">
                                    <span>âœï¸</span> DÃ¼zenle
                                </button>
                                <button class="action-btn ${task.enabled ? 'disable' : 'enable'}" onclick="toggleTask(${task.id})" title="${task.enabled ? 'KaldÄ±r' : 'AktifleÅŸtir'}">
                                    <span>${task.enabled ? 'ğŸš«' : 'âœ…'}</span> ${task.enabled ? 'KaldÄ±r' : 'AktifleÅŸtir'}
                                </button>
                                ${task.enabled ? `<button class="action-btn pin" onclick="pinTask(${task.id})" title="Sabitle"><span>ğŸ“Œ</span> Sabitle</button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button class="btn-add-new" onclick="addNewTask()">
                    <span>â•</span> Yeni GÃ¶rev Ekle
                </button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function toggleTaskMenu(taskId) {
    const menu = document.getElementById(`taskMenu${taskId}`);
    // DiÄŸer menÃ¼leri kapat
    document.querySelectorAll('.task-menu').forEach(m => {
        if (m.id !== `taskMenu${taskId}`) m.style.display = 'none';
    });
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function editTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    const modal = `
        <div class="modal" id="editTaskModal">
            <div class="modal-content">
                <h2>âœï¸ GÃ¶revi DÃ¼zenle</h2>
                <input type="text" id="editTaskTitle" value="${task.title}" placeholder="GÃ¶rev BaÅŸlÄ±ÄŸÄ±" class="input-field">
                <input type="text" id="editTaskIcon" value="${task.icon}" placeholder="Emoji (Ã¶rn: ğŸ“±)" class="input-field">
                <input type="number" id="editTaskReward" value="${task.reward}" placeholder="Ã–dÃ¼l PuanÄ±" class="input-field">
                <input type="text" id="editTaskLink" value="${task.link || ''}" placeholder="Link (opsiyonel)" class="input-field">
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="saveTaskEdit(${taskId})">Kaydet</button>
                    <button class="btn-secondary" onclick="closeEditModal()">Ä°ptal</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function saveTaskEdit(taskId) {
    const task = tasks.find(t => t.id === taskId);
    task.title = document.getElementById('editTaskTitle').value;
    task.icon = document.getElementById('editTaskIcon').value;
    task.reward = parseInt(document.getElementById('editTaskReward').value);
    task.link = document.getElementById('editTaskLink').value;
    
    saveTasksToStorage();
    closeEditModal();
    closeModal();
    renderTasks();
    alert('GÃ¶rev gÃ¼ncellendi!');
}

function closeEditModal() {
    const modal = document.getElementById('editTaskModal');
    if (modal) modal.remove();
}

function toggleTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    task.enabled = !task.enabled;
    saveTasksToStorage();
    closeModal();
    renderTasks();
    alert(task.enabled ? 'GÃ¶rev aktifleÅŸtirildi!' : 'GÃ¶rev kaldÄ±rÄ±ldÄ±!');
}

function pinTask(taskId) {
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    if (taskIndex > 0) {
        const task = tasks.splice(taskIndex, 1)[0];
        tasks.unshift(task);
        saveTasksToStorage();
        closeModal();
        renderTasks();
        alert('GÃ¶rev en Ã¼ste sabitlendi!');
    }
}

function addNewTask() {
    const modal = `
        <div class="modal" id="addTaskModal">
            <div class="modal-content">
                <h2>â• Yeni GÃ¶rev Ekle</h2>
                <input type="text" id="newTaskTitle" placeholder="GÃ¶rev BaÅŸlÄ±ÄŸÄ±" class="input-field">
                <input type="text" id="newTaskIcon" placeholder="Emoji (Ã¶rn: ğŸ®)" class="input-field">
                <input type="number" id="newTaskReward" placeholder="Ã–dÃ¼l PuanÄ±" class="input-field">
                <input type="text" id="newTaskLink" placeholder="Link (opsiyonel)" class="input-field">
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="saveNewTask()">Ekle</button>
                    <button class="btn-secondary" onclick="closeAddTaskModal()">Ä°ptal</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function saveNewTask() {
    const newTask = {
        id: Date.now(),
        title: document.getElementById('newTaskTitle').value,
        icon: document.getElementById('newTaskIcon').value,
        reward: parseInt(document.getElementById('newTaskReward').value),
        link: document.getElementById('newTaskLink').value,
        enabled: true
    };
    
    if (!newTask.title || !newTask.icon || !newTask.reward) {
        alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
        return;
    }
    
    tasks.push(newTask);
    saveTasksToStorage();
    closeAddTaskModal();
    closeModal();
    renderTasks();
    alert('Yeni gÃ¶rev eklendi!');
}

function closeAddTaskModal() {
    const modal = document.getElementById('addTaskModal');
    if (modal) modal.remove();
}

// Admin Account Management
function renderAccounts() {
    const accountsList = document.getElementById('accountsList');
    const filteredAccounts = typeof filterAndSortAccounts === 'function' ? filterAndSortAccounts() : accounts;
    
    if (filteredAccounts.length === 0) {
        accountsList.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ”</div><div class="empty-text">SonuÃ§ bulunamadÄ±</div></div>';
        return;
    }
    
    accountsList.innerHTML = filteredAccounts.map(acc => {
        const isOwner = acc.sellerId === currentUserId;
        const canEdit = isOwner || gameState.isAdmin;
        const isFav = isFavorite(acc.id);
        const hasImages = acc.images && acc.images.length > 0;
        
        return `
        <div class="account-card ${acc.featured ? 'featured' : ''}" onclick="showAccountDetail(${acc.id})">
            <button class="favorite-btn ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite(${acc.id})" title="${isFav ? 'Favorilerden Ã‡Ä±kar' : 'Favorilere Ekle'}">
                ${isFav ? 'â¤ï¸' : 'ğŸ¤'}
            </button>
            ${hasImages ? `
                <div class="account-image" style="background-image: url('${acc.images[0]}')">
                    ${acc.images.length > 1 ? `<div class="image-count">ğŸ“· ${acc.images.length}</div>` : ''}
                </div>
            ` : `<div class="account-badge">${acc.image}</div>`}
            ${acc.verified ? '<div class="verified-badge" title="DoÄŸrulanmÄ±ÅŸ SatÄ±cÄ±">âœ“</div>' : ''}
            ${acc.featured ? '<div class="vitrin-label">Vitrin Ä°lanÄ±</div>' : ''}
            ${acc.isGift ? '<div class="gift-badge">ğŸ HEDÄ°YE</div>' : ''}
            <div class="account-info">
                <div class="account-tier">${acc.tier} ${acc.verified ? '<span class="verified-icon" title="DoÄŸrulanmÄ±ÅŸ">âœ“</span>' : ''}</div>
                <div class="account-level">Seviye ${acc.level}</div>
                <div class="account-stats">
                    <span>ğŸ’ ${acc.uc} UC</span>
                    <span>ğŸ‘• ${acc.skins} Skin</span>
                    <span>ğŸ‘ï¸ ${acc.views || 0}</span>
                </div>
                <div class="account-desc">${acc.description}</div>
                <div class="account-seller">
                    SatÄ±cÄ±: @${acc.sellerUsername || acc.seller}
                    ${!isOwner ? `<button class="btn-message" onclick="event.stopPropagation(); contactSeller('${acc.sellerUsername}', ${acc.id})">ï¿½</button>` : ''}
                </div>
            </div>
            <div class="account-footer">
                <div class="account-price">
                    ${acc.priceType === 'TL' ? 'ğŸ’°' : 'ğŸ'} ${acc.price} ${acc.priceType}
                </div>
                <div class="account-actions">
                    ${!isOwner && !acc.isGift ? `<button class="btn-offer" onclick="event.stopPropagation(); makeOffer(${acc.id})">ğŸ’µ</button>` : ''}
                    <button class="btn-buy" onclick="event.stopPropagation(); buyAccount(${acc.id})">
                        ${acc.isGift ? 'ğŸ' : 'ğŸ›’'}
                    </button>
                </div>
            </div>
        </div>
    `}).join('');
}

function contactSeller(username, accountId) {
    const account = accounts.find(a => a.id === accountId);
    const message = `Merhaba! "${account.tier} Seviye ${account.level}" ilanÄ±nla ilgileniyorum.`;
    
    if (tg.openTelegramLink) {
        tg.openTelegramLink(`https://t.me/${username}?text=${encodeURIComponent(message)}`);
    } else {
        window.open(`https://t.me/${username}?text=${encodeURIComponent(message)}`, '_blank');
    }
}

function toggleCardMenu(accountId) {
    const menu = document.getElementById(`cardMenu${accountId}`);
    const allMenus = document.querySelectorAll('.card-menu');
    
    // DiÄŸer menÃ¼leri kapat
    allMenus.forEach(m => {
        if (m.id !== `cardMenu${accountId}`) {
            m.style.display = 'none';
        }
    });
    
    // Bu menÃ¼yÃ¼ aÃ§/kapat
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// MenÃ¼leri dÄ±ÅŸarÄ± tÄ±klandÄ±ÄŸÄ±nda kapat
document.addEventListener('click', (e) => {
    if (!e.target.closest('.card-menu-btn') && !e.target.closest('.card-menu')) {
        document.querySelectorAll('.card-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

function toggleAccountMenu(accountId) {
    const menu = document.getElementById(`accountMenu${accountId}`);
    document.querySelectorAll('.task-menu').forEach(m => {
        if (m.id !== `accountMenu${accountId}`) m.style.display = 'none';
    });
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function editAccount(accountId) {
    const acc = accounts.find(a => a.id === accountId);
    const canEdit = acc.sellerId === currentUserId || gameState.isAdmin;
    
    if (!canEdit) {
        alert('Bu ilanÄ± sadece sahibi dÃ¼zenleyebilir!');
        return;
    }
    
    const modal = `
        <div class="modal" id="editAccountModal">
            <div class="modal-content">
                <h2>âœï¸ HesabÄ± DÃ¼zenle</h2>
                <input type="number" id="editAccLevel" value="${acc.level}" placeholder="Seviye" class="input-field">
                <input type="text" id="editAccTier" value="${acc.tier}" placeholder="Tier" class="input-field">
                <input type="number" id="editAccUC" value="${acc.uc}" placeholder="UC" class="input-field">
                <input type="number" id="editAccSkins" value="${acc.skins}" placeholder="Skin SayÄ±sÄ±" class="input-field">
                <input type="number" id="editAccPrice" value="${acc.price}" placeholder="Fiyat" class="input-field">
                <textarea id="editAccDesc" class="input-field">${acc.description}</textarea>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="saveAccountEdit(${accountId})">Kaydet</button>
                    <button class="btn-secondary" onclick="closeEditAccountModal()">Ä°ptal</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function saveAccountEdit(accountId) {
    const acc = accounts.find(a => a.id === accountId);
    acc.level = parseInt(document.getElementById('editAccLevel').value);
    acc.tier = document.getElementById('editAccTier').value;
    acc.uc = parseInt(document.getElementById('editAccUC').value);
    acc.skins = parseInt(document.getElementById('editAccSkins').value);
    acc.price = parseInt(document.getElementById('editAccPrice').value);
    acc.description = document.getElementById('editAccDesc').value;
    
    saveAccounts();
    closeEditAccountModal();
    renderAccounts();
    alert('Hesap gÃ¼ncellendi!');
}

function closeEditAccountModal() {
    const modal = document.getElementById('editAccountModal');
    if (modal) modal.remove();
}

function deleteAccount(accountId) {
    const account = accounts.find(a => a.id === accountId);
    const canDelete = account.sellerId === currentUserId || gameState.isAdmin;
    
    if (!canDelete) {
        alert('Bu ilanÄ± sadece sahibi silebilir!');
        return;
    }
    
    if (confirm('Bu hesabÄ± silmek istediÄŸinden emin misin?')) {
        const index = accounts.findIndex(a => a.id === accountId);
        accounts.splice(index, 1);
        saveAccounts();
        renderAccounts();
        alert('Hesap silindi!');
    }
}

function toggleFeaturedAccount(accountId) {
    const acc = accounts.find(a => a.id === accountId);
    acc.featured = !acc.featured;
    saveAccounts();
    renderAccounts();
    addNotification(acc.featured ? 'â­ Hesap Ã¶ne Ã§Ä±karÄ±ldÄ±!' : 'â˜† Ã–ne Ã§Ä±karma kaldÄ±rÄ±ldÄ±!');
}


// Search & Filter Functions

function toggleFilters() {
    const panel = document.getElementById('filterPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function applyFilters() {
    filters.search = document.getElementById('searchInput').value.toLowerCase();
    filters.category = document.getElementById('categoryFilter').value;
    filters.minPrice = parseInt(document.getElementById('minPrice').value) || null;
    filters.maxPrice = parseInt(document.getElementById('maxPrice').value) || null;
    filters.minLevel = parseInt(document.getElementById('minLevel').value) || null;
    filters.maxLevel = parseInt(document.getElementById('maxLevel').value) || null;
    filters.tier = document.getElementById('tierFilter').value;
    filters.sort = document.getElementById('sortFilter').value;
    
    renderAccounts();
    toggleFilters();
}

function resetFilters() {
    filters = {
        search: '',
        category: '',
        minPrice: null,
        maxPrice: null,
        minLevel: null,
        maxLevel: null,
        tier: '',
        sort: 'newest'
    };
    
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    document.getElementById('minLevel').value = '';
    document.getElementById('maxLevel').value = '';
    document.getElementById('tierFilter').value = '';
    document.getElementById('sortFilter').value = 'newest';
    
    renderAccounts();
}

// Real-time search
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            filters.search = e.target.value.toLowerCase();
            renderAccounts();
        });
    }
});


// Back button functionality
function goBack(fromPage) {
    console.log('goBack called from:', fromPage);
    
    // Hide current page
    const currentPage = document.getElementById(fromPage + 'Page');
    if (currentPage) {
        currentPage.style.display = 'none';
    }
    
    // Show home page
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
        mainContent.style.display = 'flex';
        console.log('Main content display set to flex');
    }
    
    // Update nav
    navItems.forEach(nav => nav.classList.remove('active'));
    const homeNav = document.querySelector('[data-page="home"]');
    if (homeNav) {
        homeNav.classList.add('active');
    }
    
    // Re-render accounts to ensure they display
    console.log('Calling renderAccounts...');
    renderAccounts();
    console.log('Accounts rendered, total:', accounts.length);
}


// Favorites Page
function renderFavorites() {
    const favoritesList = document.getElementById('favoritesList');
    const favoriteAccounts = accounts.filter(a => gameState.favorites.includes(a.id));
    
    if (favoriteAccounts.length === 0) {
        favoritesList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">â¤ï¸</div>
                <div class="empty-text">HenÃ¼z favori hesabÄ±n yok</div>
                <button class="btn-primary" onclick="showPage('home')">Ä°lanlarÄ± GÃ¶r</button>
            </div>
        `;
        return;
    }
    
    favoritesList.innerHTML = favoriteAccounts.map(acc => {
        const isOwner = acc.sellerId === currentUserId;
        return `
        <div class="account-card ${acc.featured ? 'featured' : ''}">
            <button class="favorite-btn active" onclick="event.stopPropagation(); toggleFavorite(${acc.id})">â¤ï¸</button>
            <div class="account-badge">${acc.image}</div>
            ${acc.verified ? '<div class="verified-badge">âœ“</div>' : ''}
            ${acc.featured ? '<div class="vitrin-label">Vitrin Ä°lanÄ±</div>' : ''}
            <div class="account-info">
                <div class="account-tier">${acc.tier}</div>
                <div class="account-level">Seviye ${acc.level}</div>
                <div class="account-stats">
                    <span>ğŸ’ ${acc.uc} UC</span>
                    <span>ğŸ‘• ${acc.skins} Skin</span>
                </div>
                <div class="account-desc">${acc.description}</div>
            </div>
            <div class="account-footer">
                <div class="account-price">${acc.priceType === 'TL' ? 'ğŸ’°' : 'ğŸ'} ${acc.price} ${acc.priceType}</div>
                <button class="btn-buy" onclick="buyAccount(${acc.id})">${acc.isGift ? 'ğŸ' : 'ğŸ›’'}</button>
            </div>
        </div>
        `;
    }).join('');
}

// Notifications Page
function showNotifications() {
    showPage('notifications');
    renderNotifications();
}

function renderNotifications() {
    const notificationsList = document.getElementById('notificationsList');
    
    // Mark all as read
    gameState.notifications.forEach(n => n.read = true);
    saveGame();
    updateNotificationBadge();
    
    if (gameState.notifications.length === 0) {
        notificationsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ””</div>
                <div class="empty-text">HenÃ¼z bildirim yok</div>
            </div>
        `;
        return;
    }
    
    notificationsList.innerHTML = gameState.notifications.map(notif => {
        const date = new Date(notif.timestamp);
        const timeAgo = getTimeAgo(notif.timestamp);
        return `
        <div class="notification-item ${notif.type}">
            <div class="notification-content">
                <div class="notification-message">${notif.message}</div>
                <div class="notification-time">${timeAgo}</div>
            </div>
            <button class="notification-delete" onclick="deleteNotification(${notif.id})">âœ•</button>
        </div>
        `;
    }).join('');
}

function deleteNotification(notifId) {
    gameState.notifications = gameState.notifications.filter(n => n.id !== notifId);
    saveGame();
    renderNotifications();
}

function getTimeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'Az Ã¶nce';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} dakika Ã¶nce`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} saat Ã¶nce`;
    const days = Math.floor(hours / 24);
    return `${days} gÃ¼n Ã¶nce`;
}

// Statistics Page
function showStats() {
    showPage('stats');
    renderStats();
}

function renderStats() {
    const statsContent = document.getElementById('statsContent');
    const myAccounts = accounts.filter(a => a.sellerId === currentUserId);
    const totalViews = myAccounts.reduce((sum, acc) => sum + (acc.views || 0), 0);
    const totalSales = gameState.purchasedAccounts.length;
    const totalRevenue = myAccounts.reduce((sum, acc) => sum + (acc.price || 0), 0);
    
    statsContent.innerHTML = `
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-box-value">${myAccounts.length}</div>
                <div class="stat-box-label">Aktif Ä°lan</div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value">${totalViews}</div>
                <div class="stat-box-label">Toplam GÃ¶rÃ¼ntÃ¼lenme</div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value">${totalSales}</div>
                <div class="stat-box-label">SatÄ±n AlÄ±nan</div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value">${totalRevenue} TL</div>
                <div class="stat-box-label">Potansiyel Gelir</div>
            </div>
        </div>
        
        <h3 style="margin: 20px 0 10px 0;">En Ã‡ok GÃ¶rÃ¼ntÃ¼lenen Ä°lanlar</h3>
        ${myAccounts.sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 5).map(acc => `
            <div class="stat-item">
                <div class="stat-item-info">
                    <div class="stat-item-title">${acc.tier} - Seviye ${acc.level}</div>
                    <div class="stat-item-subtitle">${acc.views || 0} gÃ¶rÃ¼ntÃ¼lenme</div>
                </div>
                <div class="stat-item-value">${acc.price} ${acc.priceType}</div>
            </div>
        `).join('')}
        
        <h3 style="margin: 20px 0 10px 0;">Favori Ä°statistikleri</h3>
        <div class="stat-item">
            <div class="stat-item-info">
                <div class="stat-item-title">Favorilere Eklenen Ä°lanlarÄ±n</div>
            </div>
            <div class="stat-item-value">${myAccounts.filter(a => gameState.favorites.includes(a.id)).length}</div>
        </div>
    `;
}

// Helper function to show pages
function showPage(pageName) {
    Object.keys(pages).forEach(key => {
        if (pages[key]) {
            pages[key].style.display = key === pageName ? (key === 'home' ? '' : 'block') : 'none';
        }
    });
    
    navItems.forEach(nav => nav.classList.remove('active'));
    const activeNav = document.querySelector(`[data-page="${pageName}"]`);
    if (activeNav) activeNav.classList.add('active');
}

// Update initial render
updateNotificationBadge();


// Account Detail Modal
function showAccountDetail(accountId) {
    incrementViews(accountId);
    const acc = accounts.find(a => a.id === accountId);
    if (!acc) return;
    
    const isOwner = acc.sellerId === currentUserId;
    const isFav = isFavorite(acc.id);
    const hasImages = acc.images && acc.images.length > 0;
    
    const modal = `
        <div class="modal detail-modal" id="accountDetailModal">
            <div class="detail-modal-content">
                <button class="detail-close-btn" onclick="closeDetailModal()">âœ•</button>
                
                ${hasImages ? `
                    <div class="detail-image-slider">
                        <div class="detail-images" id="detailImages">
                            ${acc.images.map((img, index) => `
                                <img src="${img}" alt="Screenshot ${index + 1}" class="detail-image ${index === 0 ? 'active' : ''}" onclick="changeDetailImage(${index})">
                            `).join('')}
                        </div>
                        ${acc.images.length > 1 ? `
                            <div class="detail-image-dots">
                                ${acc.images.map((_, index) => `
                                    <span class="dot ${index === 0 ? 'active' : ''}" onclick="changeDetailImage(${index})"></span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div class="detail-badge">${acc.image}</div>
                `}
                
                <div class="detail-content">
                    <div class="detail-header">
                        <div>
                            <h2>${acc.tier} ${acc.verified ? '<span class="verified-icon">âœ“</span>' : ''}</h2>
                            <p class="detail-level">Seviye ${acc.level}</p>
                        </div>
                        <button class="favorite-btn-large ${isFav ? 'active' : ''}" onclick="toggleFavorite(${acc.id}); updateDetailFavorite(${acc.id})">
                            ${isFav ? 'â¤ï¸' : 'ğŸ¤'}
                        </button>
                    </div>
                    
                    <div class="detail-stats">
                        <div class="detail-stat">
                            <div class="detail-stat-icon">ğŸ’</div>
                            <div class="detail-stat-value">${acc.uc}</div>
                            <div class="detail-stat-label">UC</div>
                        </div>
                        <div class="detail-stat">
                            <div class="detail-stat-icon">ğŸ‘•</div>
                            <div class="detail-stat-value">${acc.skins}</div>
                            <div class="detail-stat-label">Skin</div>
                        </div>
                        <div class="detail-stat">
                            <div class="detail-stat-icon">ğŸ‘ï¸</div>
                            <div class="detail-stat-value">${acc.views || 0}</div>
                            <div class="detail-stat-label">GÃ¶rÃ¼ntÃ¼lenme</div>
                        </div>
                    </div>
                    
                    <div class="detail-description">
                        <h3>AÃ§Ä±klama</h3>
                        <p>${acc.description}</p>
                    </div>
                    
                    <div class="detail-seller">
                        <div class="detail-seller-info">
                            <div class="detail-seller-avatar">ğŸ‘¤</div>
                            <div>
                                <div class="detail-seller-name">@${acc.sellerUsername || acc.seller}</div>
                                <div class="detail-seller-label">SatÄ±cÄ±</div>
                            </div>
                        </div>
                        ${!isOwner ? `
                            <button class="btn-contact" onclick="contactSeller('${acc.sellerUsername}', ${acc.id})">
                                ğŸ’¬ Mesaj GÃ¶nder
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="detail-footer">
                        <div class="detail-price">
                            <div class="detail-price-label">Fiyat</div>
                            <div class="detail-price-value">${acc.priceType === 'TL' ? 'ğŸ’°' : 'ğŸ'} ${acc.price} ${acc.priceType}</div>
                        </div>
                        <div class="detail-actions">
                            ${!isOwner && !acc.isGift ? `
                                <button class="btn-offer-large" onclick="makeOffer(${acc.id})">
                                    ğŸ’µ Teklif Ver
                                </button>
                            ` : ''}
                            <button class="btn-buy-large" onclick="buyAccount(${acc.id})">
                                ${acc.isGift ? 'ğŸ Talep Et' : 'ğŸ›’ SatÄ±n Al'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
}

let currentImageIndex = 0;

function changeDetailImage(index) {
    const images = document.querySelectorAll('.detail-image');
    const dots = document.querySelectorAll('.dot');
    
    images.forEach((img, i) => {
        img.classList.toggle('active', i === index);
    });
    
    dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
    });
    
    currentImageIndex = index;
}

function updateDetailFavorite(accountId) {
    const btn = document.querySelector('.favorite-btn-large');
    if (btn) {
        const isFav = isFavorite(accountId);
        btn.classList.toggle('active', isFav);
        btn.textContent = isFav ? 'â¤ï¸' : 'ğŸ¤';
    }
}

function closeDetailModal() {
    const modal = document.getElementById('accountDetailModal');
    if (modal) modal.remove();
    currentImageIndex = 0;
}


// Language System
const translations = {
    tr: {
        store: 'MaÄŸaza',
        favorites: 'Favoriler',
        earn: 'Kazan',
        myAccounts: 'HesaplarÄ±m',
        friends: 'ArkadaÅŸlar',
        search: 'Ara...',
        filter: 'Filtre',
        category: 'Kategori',
        all: 'TÃ¼mÃ¼',
        onlySale: 'Sadece SatÄ±lÄ±k',
        onlyGift: 'Sadece Hediye',
        verified: 'DoÄŸrulanmÄ±ÅŸ SatÄ±cÄ±lar',
        price: 'Fiyat',
        level: 'Seviye',
        tier: 'Tier',
        sort: 'SÄ±ralama',
        newest: 'En Yeni',
        popular: 'En PopÃ¼ler',
        priceLow: 'Ucuz â†’ PahalÄ±',
        priceHigh: 'PahalÄ± â†’ Ucuz',
        levelHigh: 'YÃ¼ksek Seviye',
        apply: 'Uygula',
        reset: 'SÄ±fÄ±rla',
        seller: 'SatÄ±cÄ±',
        buy: 'SatÄ±n Al',
        offer: 'Teklif Ver',
        addToFavorites: 'Favorilere Ekle',
        removeFromFavorites: 'Favorilerden Ã‡Ä±kar',
        edit: 'DÃ¼zenle',
        delete: 'Sil',
        featured: 'Ã–ne Ã‡Ä±kar',
        addAccount: 'Hesap Ekle',
        noResults: 'SonuÃ§ bulunamadÄ±',
        notifications: 'Bildirimler',
        stats: 'Ä°statistikler'
    },
    en: {
        store: 'Store',
        favorites: 'Favorites',
        earn: 'Earn',
        myAccounts: 'My Accounts',
        friends: 'Friends',
        search: 'Search...',
        filter: 'Filter',
        category: 'Category',
        all: 'All',
        onlySale: 'For Sale Only',
        onlyGift: 'Gift Only',
        verified: 'Verified Sellers',
        price: 'Price',
        level: 'Level',
        tier: 'Tier',
        sort: 'Sort',
        newest: 'Newest',
        popular: 'Most Popular',
        priceLow: 'Price: Low to High',
        priceHigh: 'Price: High to Low',
        levelHigh: 'Level: High to Low',
        apply: 'Apply',
        reset: 'Reset',
        seller: 'Seller',
        buy: 'Buy',
        offer: 'Make Offer',
        addToFavorites: 'Add to Favorites',
        removeFromFavorites: 'Remove from Favorites',
        edit: 'Edit',
        delete: 'Delete',
        featured: 'Feature',
        addAccount: 'Add Account',
        noResults: 'No results found',
        notifications: 'Notifications',
        stats: 'Statistics'
    }
};

function t(key) {
    return translations[gameState.language][key] || key;
}

function changeLanguage(lang) {
    gameState.language = lang;
    saveGame();
    updateLanguageUI();
    renderAccounts();
    renderFavorites();
    addNotification(lang === 'tr' ? 'ğŸŒ Dil TÃ¼rkÃ§e olarak deÄŸiÅŸtirildi' : 'ğŸŒ Language changed to English');
}

function updateLanguageUI() {
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === gameState.language);
    });
}

// Profile System
function showProfile() {
    showPage('profile');
    renderProfile();
}

function renderProfile() {
    const profileContent = document.getElementById('profileContent');
    const myAccounts = accounts.filter(a => a.sellerId === currentUserId);
    const totalViews = myAccounts.reduce((sum, acc) => sum + (acc.views || 0), 0);
    const totalSales = gameState.purchasedAccounts.length;
    
    profileContent.innerHTML = `
        <div class="profile-header">
            <div class="profile-avatar">ğŸ‘¤</div>
            <div class="profile-info">
                <h2>${userProfile ? userProfile.fullName : currentUsername}</h2>
                <p>@${userProfile ? userProfile.telegram : currentUsername}</p>
                <p style="font-size: 12px; opacity: 0.6; margin-top: 4px;">
                    ${gameState.isAdmin ? 'ğŸ‘‘ Admin' : 'ğŸ‘¤ KullanÄ±cÄ±'}
                    ${userProfile && userProfile.verified ? ' â€¢ âœ“ DoÄŸrulanmÄ±ÅŸ' : ''}
                </p>
            </div>
        </div>
        
        <div class="profile-stats">
            <div class="profile-stat">
                <div class="profile-stat-value">${myAccounts.length}</div>
                <div class="profile-stat-label">Aktif Ä°lan</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-value">${totalViews}</div>
                <div class="profile-stat-label">GÃ¶rÃ¼ntÃ¼lenme</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-value">${gameState.favorites.length}</div>
                <div class="profile-stat-label">Favori</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-value">${gameState.points}</div>
                <div class="profile-stat-label">Puan</div>
            </div>
        </div>
        
        ${userProfile ? `
        <div class="profile-section">
            <h3>ğŸ‘¤ Hesap Bilgileri</h3>
            <div class="settings-list">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Ad Soyad</div>
                        <div class="setting-subtitle">${userProfile.fullName}</div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Telegram</div>
                        <div class="setting-subtitle">@${userProfile.telegram}</div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">KayÄ±t Tarihi</div>
                        <div class="setting-subtitle">${new Date(userProfile.registeredAt).toLocaleDateString('tr-TR')}</div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">DoÄŸrulama Durumu</div>
                        <div class="setting-subtitle">
                            ${userProfile.verified 
                                ? `âœ… DoÄŸrulanmÄ±ÅŸ (${userProfile.verificationMethod === 'telegram' ? 'Telegram' : userProfile.verificationMethod === 'email' ? 'E-posta' : userProfile.verificationMethod === 'id' ? 'Kimlik' : 'Ã–deme'})`
                                : userProfile.verificationRejected
                                    ? `âŒ Reddedildi${userProfile.rejectionReason ? ': ' + userProfile.rejectionReason : ''}`
                                    : userProfile.verificationPending 
                                        ? 'â³ Onay Bekleniyor' 
                                        : 'âŒ DoÄŸrulanmamÄ±ÅŸ'
                            }
                        </div>
                    </div>
                    ${!userProfile.verified && !userProfile.verificationPending ? `
                        <button class="btn-verify" onclick="showVerificationOptions()">${userProfile.verificationRejected ? 'Tekrar Dene' : 'DoÄŸrula'}</button>
                    ` : ''}
                </div>
            </div>
        </div>
        ` : ''}
        
        <div class="profile-section">
            <h3>âš™ï¸ Ayarlar</h3>
            <div class="settings-list">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">ğŸŒ Dil / Language</div>
                        <div class="setting-subtitle">Uygulama dilini deÄŸiÅŸtir</div>
                    </div>
                    <div class="language-switcher-inline">
                        <button class="lang-btn ${gameState.language === 'tr' ? 'active' : ''}" onclick="changeLanguage('tr')">TR</button>
                        <button class="lang-btn ${gameState.language === 'en' ? 'active' : ''}" onclick="changeLanguage('en')">EN</button>
                    </div>
                </div>
                
                <div class="setting-item" onclick="showNotificationSettings()">
                    <div class="setting-info">
                        <div class="setting-title">ğŸ”” Bildirim AyarlarÄ±</div>
                        <div class="setting-subtitle">Bildirimleri yÃ¶net</div>
                    </div>
                    <div class="setting-arrow">â€º</div>
                </div>
                
                ${gameState.isAdmin ? `
                <div class="setting-item" onclick="showIDVerificationApprovals()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="setting-info">
                        <div class="setting-title">ï¿½ Kimlik OnaylarÄ±</div>
                        <div class="setting-subtitle" style="color: rgba(255,255,255,0.8);">Bekleyen doÄŸrulama talepleri</div>
                    </div>
                    <div class="setting-arrow">â€º</div>
                </div>
                ` : ''}
                
                <div class="setting-item" onclick="showSearchHistory()">
                    <div class="setting-info">
                        <div class="setting-title">ğŸ” Arama GeÃ§miÅŸi</div>
                        <div class="setting-subtitle">Son aramalarÄ±nÄ± gÃ¶r</div>
                    </div>
                    <div class="setting-arrow">â€º</div>
                </div>
                
                <div class="setting-item" onclick="showRecentlyViewed()">
                    <div class="setting-info">
                        <div class="setting-title">ğŸ‘ï¸ Son GÃ¶rÃ¼ntÃ¼lenenler</div>
                        <div class="setting-subtitle">Son baktÄ±ÄŸÄ±n ilanlar</div>
                    </div>
                    <div class="setting-arrow">â€º</div>
                </div>
                
                <div class="setting-item" onclick="showSupport()">
                    <div class="setting-info">
                        <div class="setting-title">ğŸ’¬ CanlÄ± Destek</div>
                        <div class="setting-subtitle">YardÄ±m al</div>
                    </div>
                    <div class="setting-arrow">â€º</div>
                </div>
            </div>
        </div>
        
        <button class="btn-logout" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
    `;
}

function logout() {
    if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinden emin misin?')) {
        localStorage.clear();
        location.reload();
    }
}

// Search History
let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');

function addToSearchHistory(query) {
    if (!query || query.length < 2) return;
    searchHistory = [query, ...searchHistory.filter(q => q !== query)].slice(0, 10);
    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
}

function showSearchHistory() {
    const modal = `
        <div class="modal" id="searchHistoryModal">
            <div class="modal-content">
                <h2>ğŸ” Arama GeÃ§miÅŸi</h2>
                ${searchHistory.length > 0 ? `
                    <div class="history-list">
                        ${searchHistory.map(query => `
                            <div class="history-item" onclick="searchFromHistory('${query}')">
                                <span>ğŸ” ${query}</span>
                                <button class="history-remove" onclick="event.stopPropagation(); removeFromHistory('${query}')">âœ•</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-secondary" onclick="clearSearchHistory()" style="margin-top: 16px;">GeÃ§miÅŸi Temizle</button>
                ` : '<p style="text-align: center; opacity: 0.6;">HenÃ¼z arama yapmadÄ±n</p>'}
                <button class="btn-primary" onclick="closeModal('searchHistoryModal')" style="margin-top: 16px;">Kapat</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function searchFromHistory(query) {
    closeModal('searchHistoryModal');
    showPage('home');
    document.getElementById('searchInput').value = query;
    filters.search = query.toLowerCase();
    renderAccounts();
}

function removeFromHistory(query) {
    searchHistory = searchHistory.filter(q => q !== query);
    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    closeModal('searchHistoryModal');
    showSearchHistory();
}

function clearSearchHistory() {
    searchHistory = [];
    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    closeModal('searchHistoryModal');
    addNotification('ğŸ—‘ï¸ Arama geÃ§miÅŸi temizlendi');
}

// Recently Viewed
let recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');

function addToRecentlyViewed(accountId) {
    recentlyViewed = [accountId, ...recentlyViewed.filter(id => id !== accountId)].slice(0, 20);
    localStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed));
}

function showRecentlyViewed() {
    const recentAccounts = recentlyViewed.map(id => accounts.find(a => a.id === id)).filter(a => a);
    
    const modal = `
        <div class="modal" id="recentlyViewedModal">
            <div class="modal-content" style="max-width: 600px;">
                <h2>ğŸ‘ï¸ Son GÃ¶rÃ¼ntÃ¼lenenler</h2>
                ${recentAccounts.length > 0 ? `
                    <div class="recent-grid">
                        ${recentAccounts.map(acc => `
                            <div class="recent-item" onclick="closeModal('recentlyViewedModal'); showAccountDetail(${acc.id})">
                                <div class="recent-image">${acc.images && acc.images[0] ? `<img src="${acc.images[0]}" alt="">` : acc.image}</div>
                                <div class="recent-info">
                                    <div class="recent-title">${acc.tier} - Seviye ${acc.level}</div>
                                    <div class="recent-price">${acc.price} ${acc.priceType}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-secondary" onclick="clearRecentlyViewed()" style="margin-top: 16px;">GeÃ§miÅŸi Temizle</button>
                ` : '<p style="text-align: center; opacity: 0.6;">HenÃ¼z ilan gÃ¶rÃ¼ntÃ¼lemedin</p>'}
                <button class="btn-primary" onclick="closeModal('recentlyViewedModal')" style="margin-top: 16px;">Kapat</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function clearRecentlyViewed() {
    recentlyViewed = [];
    localStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed));
    closeModal('recentlyViewedModal');
    addNotification('ğŸ—‘ï¸ GÃ¶rÃ¼ntÃ¼leme geÃ§miÅŸi temizlendi');
}

// Notification Settings
let notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{"newListings": true, "priceDrops": true, "messages": true, "offers": true}');

function showNotificationSettings() {
    const modal = `
        <div class="modal" id="notificationSettingsModal">
            <div class="modal-content">
                <h2>ğŸ”” Bildirim AyarlarÄ±</h2>
                <div class="settings-list">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">ğŸ†• Yeni Ä°lanlar</div>
                            <div class="setting-subtitle">Yeni ilan eklendiÄŸinde bildir</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${notificationSettings.newListings ? 'checked' : ''} onchange="toggleNotification('newListings')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">ğŸ’° Fiyat DÃ¼ÅŸÃ¼ÅŸleri</div>
                            <div class="setting-subtitle">Favorilerdeki fiyat dÃ¼ÅŸÃ¼nce bildir</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${notificationSettings.priceDrops ? 'checked' : ''} onchange="toggleNotification('priceDrops')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">ğŸ’¬ Mesajlar</div>
                            <div class="setting-subtitle">Yeni mesaj geldiÄŸinde bildir</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${notificationSettings.messages ? 'checked' : ''} onchange="toggleNotification('messages')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">ğŸ’µ Teklifler</div>
                            <div class="setting-subtitle">Teklif geldiÄŸinde bildir</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${notificationSettings.offers ? 'checked' : ''} onchange="toggleNotification('offers')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <button class="btn-primary" onclick="closeModal('notificationSettingsModal')" style="margin-top: 16px;">Kapat</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function toggleNotification(type) {
    notificationSettings[type] = !notificationSettings[type];
    localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
    addNotification(notificationSettings[type] ? 'âœ… Bildirim aÃ§Ä±ldÄ±' : 'âŒ Bildirim kapatÄ±ldÄ±');
}

// Support System
function showSupport() {
    const modal = `
        <div class="modal" id="supportModal">
            <div class="modal-content">
                <h2>ğŸ’¬ CanlÄ± Destek</h2>
                <div class="support-options">
                    <button class="support-btn" onclick="openTelegramSupport()">
                        <span class="support-icon">ğŸ“±</span>
                        <div class="support-info">
                            <div class="support-title">Telegram Destek</div>
                            <div class="support-subtitle">Telegram Ã¼zerinden yardÄ±m al</div>
                        </div>
                    </button>
                    <button class="support-btn" onclick="showFAQ()">
                        <span class="support-icon">â“</span>
                        <div class="support-info">
                            <div class="support-title">SÄ±k Sorulan Sorular</div>
                            <div class="support-subtitle">HÄ±zlÄ± cevaplar bul</div>
                        </div>
                    </button>
                    <button class="support-btn" onclick="reportProblem()">
                        <span class="support-icon">ğŸ›</span>
                        <div class="support-info">
                            <div class="support-title">Sorun Bildir</div>
                            <div class="support-subtitle">Hata veya Ã¶neri gÃ¶nder</div>
                        </div>
                    </button>
                </div>
                <button class="btn-primary" onclick="closeModal('supportModal')" style="margin-top: 16px;">Kapat</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function openTelegramSupport() {
    window.open('https://t.me/yoursupport', '_blank');
}

function showFAQ() {
    closeModal('supportModal');
    const modal = `
        <div class="modal" id="faqModal">
            <div class="modal-content">
                <h2>â“ SÄ±k Sorulan Sorular</h2>
                <div class="faq-list">
                    <div class="faq-item">
                        <div class="faq-question">NasÄ±l hesap satarÄ±m?</div>
                        <div class="faq-answer">"HesaplarÄ±m" sekmesinden "Hesap Ekle" butonuna tÄ±klayarak ilanÄ±nÄ± oluÅŸturabilirsin.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">Ã–deme nasÄ±l yapÄ±lÄ±r?</div>
                        <div class="faq-answer">SatÄ±cÄ±yla direkt iletiÅŸime geÃ§erek Ã¶deme detaylarÄ±nÄ± konuÅŸabilirsiniz.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">Hesap gÃ¼venli mi?</div>
                        <div class="faq-answer">DoÄŸrulanmÄ±ÅŸ satÄ±cÄ±lardan alÄ±ÅŸveriÅŸ yapmanÄ±zÄ± Ã¶neririz. âœ“ iÅŸareti olan satÄ±cÄ±lar gÃ¼venilirdir.</div>
                    </div>
                </div>
                <button class="btn-primary" onclick="closeModal('faqModal')" style="margin-top: 16px;">Kapat</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function reportProblem() {
    closeModal('supportModal');
    const modal = `
        <div class="modal" id="reportModal">
            <div class="modal-content">
                <h2>ğŸ› Sorun Bildir</h2>
                <textarea id="reportText" class="input-field" placeholder="Sorunu veya Ã¶nerini detaylÄ± anlat..." rows="5"></textarea>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="submitReport()">GÃ¶nder</button>
                    <button class="btn-secondary" onclick="closeModal('reportModal')">Ä°ptal</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function submitReport() {
    const text = document.getElementById('reportText').value;
    if (text.trim()) {
        addNotification('âœ… Raporun gÃ¶nderildi! TeÅŸekkÃ¼rler.');
        closeModal('reportModal');
    } else {
        alert('LÃ¼tfen bir aÃ§Ä±klama yaz!');
    }
}

// Update incrementViews to add to recently viewed
const originalIncrementViews = incrementViews;
incrementViews = function(accountId) {
    originalIncrementViews(accountId);
    addToRecentlyViewed(accountId);
};

// Update search to add to history
const searchInput = document.getElementById('searchInput');
if (searchInput) {
    searchInput.addEventListener('change', (e) => {
        if (e.target.value) {
            addToSearchHistory(e.target.value);
        }
    });
}


// Verification System
function showVerificationOptions() {
    if (userProfile && userProfile.verified) {
        addNotification('âœ… HesabÄ±n zaten doÄŸrulanmÄ±ÅŸ!');
        return;
    }
    
    const modal = `
        <div class="modal" id="verificationModal">
            <div class="modal-content" style="max-width: 500px;">
                <h2>âœ“ Hesap DoÄŸrulama</h2>
                <p style="text-align: center; color: #8b8d98; margin-bottom: 24px;">
                    HesabÄ±nÄ± doÄŸrulayarak gÃ¼venilir satÄ±cÄ± rozetini kazan ve daha fazla alÄ±cÄ±ya ulaÅŸ!
                </p>
                
                <div class="verification-methods">
                    <button class="verification-method-btn" onclick="startIDVerification()">
                        <div class="verification-icon">ï¿½</div>
                        <div class="verification-info">
                            <div class="verification-title">Kimlik DoÄŸrulamasÄ±</div>
                            <div class="verification-subtitle">Kimlik belgesi ile doÄŸrula</div>
                            <div class="verification-badge recommended">Ã–nerilen</div>
                        </div>
                        <div class="verification-arrow">â€º</div>
                    </button>
                    
                    <button class="verification-method-btn" onclick="startEmailVerification()">
                        <div class="verification-icon">ğŸ“§</div>
                        <div class="verification-info">
                            <div class="verification-title">E-posta DoÄŸrulamasÄ±</div>
                            <div class="verification-subtitle">E-posta adresine kod gÃ¶nder</div>
                        </div>
                        <div class="verification-arrow">â€º</div>
                    </button>
                    
                    <button class="verification-method-btn" onclick="startPaymentVerification()">
                        <div class="verification-icon">ï¿½</div>
                        <div class="verification-info">
                            <div class="verification-title">Ã–deme DoÄŸrulamasÄ±</div>
                            <div class="verification-subtitle">1 TL ile anÄ±nda doÄŸrula</div>
                            <div class="verification-badge instant">AnÄ±nda</div>
                        </div>
                        <div class="verification-arrow">â€º</div>
                    </button>
                </div>
                
                <button class="btn-secondary" onclick="closeModal('verificationModal')" style="margin-top: 16px;">Ä°ptal</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

// 1. Telegram Verification
function startTelegramVerification() {
    closeModal('verificationModal');
    
    const verificationCode = Math.floor(100000 + Math.random() * 900000);
    localStorage.setItem('telegramVerificationCode', verificationCode.toString());
    
    const modal = `
        <div class="modal" id="telegramVerificationModal">
            <div class="modal-content">
                <h2>ğŸ“± Telegram DoÄŸrulamasÄ±</h2>
                
                <div class="verification-steps">
                    <div class="verification-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Telegram Botuna Git</div>
                            <div class="step-description">AÅŸaÄŸÄ±daki butona tÄ±klayarak destek botumuza git</div>
                            <button class="btn-telegram" onclick="openVerificationBot()">
                                ğŸ“± Telegram Botunu AÃ§
                            </button>
                        </div>
                    </div>
                    
                    <div class="verification-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">DoÄŸrulama Kodunu GÃ¶nder</div>
                            <div class="step-description">Bota aÅŸaÄŸÄ±daki kodu gÃ¶nder:</div>
                            <div class="verification-code-display">
                                <span class="code-text">${verificationCode}</span>
                                <button class="code-copy-btn" onclick="copyVerificationCode('${verificationCode}')">ğŸ“‹</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="verification-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Onay Kodunu Gir</div>
                            <div class="step-description">Bot sana bir onay kodu gÃ¶nderecek, buraya gir:</div>
                            <input type="text" id="telegramConfirmCode" class="verification-input" placeholder="6 haneli kod" maxlength="6">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button class="btn-primary" onclick="confirmTelegramVerification()">âœ“ DoÄŸrula</button>
                    <button class="btn-secondary" onclick="closeModal('telegramVerificationModal')">Ä°ptal</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function openVerificationBot() {
    openTelegramBot(userProfile.telegram);
}

function copyVerificationCode(code) {
    navigator.clipboard.writeText(code);
    addNotification('ğŸ“‹ Kod kopyalandÄ±!');
}

async function confirmTelegramVerification() {
    const enteredCode = document.getElementById('telegramConfirmCode').value;
    
    if (enteredCode.length !== 6) {
        alert('âŒ LÃ¼tfen 6 haneli onay kodunu gir!');
        return;
    }
    
    try {
        // Backend'e doÄŸrulama isteÄŸi gÃ¶nder
        const response = await fetch('http://localhost:3000/api/verify-telegram', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: currentUserId || userProfile.telegram,
                code: enteredCode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            userProfile.verified = true;
            userProfile.verificationMethod = 'telegram';
            userProfile.verifiedAt = Date.now();
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            closeModal('telegramVerificationModal');
            addNotification('ğŸ‰ Tebrikler! HesabÄ±n doÄŸrulandÄ±!');
            renderProfile();
        } else {
            alert('âŒ GeÃ§ersiz veya sÃ¼resi dolmuÅŸ kod! LÃ¼tfen tekrar dene.');
        }
    } catch (error) {
        console.error('Verification error:', error);
        alert('âŒ DoÄŸrulama sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen tekrar dene.');
    }
}

// 2. Email Verification
function startEmailVerification() {
    closeModal('verificationModal');
    
    const modal = `
        <div class="modal" id="emailVerificationModal">
            <div class="modal-content">
                <h2>ğŸ“§ E-posta DoÄŸrulamasÄ±</h2>
                
                <div class="verification-steps">
                    <div class="verification-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">E-posta Adresini Gir</div>
                            <input type="email" id="verificationEmail" class="verification-input" placeholder="ornek@email.com">
                        </div>
                    </div>
                    
                    <div class="verification-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Kod GÃ¶nder</div>
                            <button class="btn-primary" onclick="sendEmailVerificationCode()" style="width: 100%;">
                                ğŸ“§ DoÄŸrulama Kodu GÃ¶nder
                            </button>
                        </div>
                    </div>
                    
                    <div class="verification-step" id="emailCodeStep" style="display: none;">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Kodu Gir</div>
                            <div class="step-description">E-postana gÃ¶nderilen 6 haneli kodu gir:</div>
                            <input type="text" id="emailConfirmCode" class="verification-input" placeholder="6 haneli kod" maxlength="6">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button class="btn-primary" onclick="confirmEmailVerification()" id="emailConfirmBtn" style="display: none;">âœ“ DoÄŸrula</button>
                    <button class="btn-secondary" onclick="closeModal('emailVerificationModal')">Ä°ptal</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function sendEmailVerificationCode() {
    const email = document.getElementById('verificationEmail').value;
    
    if (!email || !email.includes('@')) {
        alert('âŒ LÃ¼tfen geÃ§erli bir e-posta adresi gir!');
        return;
    }
    
    const code = Math.floor(100000 + Math.random() * 900000);
    localStorage.setItem('emailVerificationCode', code.toString());
    localStorage.setItem('verificationEmail', email);
    
    // SimÃ¼lasyon - gerÃ§ekte e-posta gÃ¶nderilecek
    addNotification(`ğŸ“§ DoÄŸrulama kodu gÃ¶nderildi! (Test: ${code})`);
    
    document.getElementById('emailCodeStep').style.display = 'flex';
    document.getElementById('emailConfirmBtn').style.display = 'block';
}

function confirmEmailVerification() {
    const enteredCode = document.getElementById('emailConfirmCode').value;
    const savedCode = localStorage.getItem('emailVerificationCode');
    
    if (enteredCode === savedCode) {
        userProfile.verified = true;
        userProfile.verificationMethod = 'email';
        userProfile.verifiedAt = Date.now();
        userProfile.email = localStorage.getItem('verificationEmail');
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        
        closeModal('emailVerificationModal');
        addNotification('ğŸ‰ Tebrikler! HesabÄ±n doÄŸrulandÄ±!');
        renderProfile();
    } else {
        alert('âŒ HatalÄ± kod! LÃ¼tfen tekrar dene.');
    }
}

// 3. ID Verification
function startIDVerification() {
    closeModal('verificationModal');
    
    const modal = `
        <div class="modal" id="idVerificationModal">
            <div class="modal-content">
                <h2>ğŸ“¸ Kimlik DoÄŸrulamasÄ±</h2>
                
                <div class="verification-steps">
                    <div class="verification-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Kimlik Belgesinin Ã–n YÃ¼zÃ¼</div>
                            <div class="step-description">Kimlik kartÄ± veya ehliyet Ã¶n yÃ¼zÃ¼nÃ¼ yÃ¼kle</div>
                            <label class="file-upload-btn">
                                ğŸ“· FotoÄŸraf SeÃ§
                                <input type="file" accept="image/*" onchange="previewIDImage(event, 'front')" style="display: none;">
                            </label>
                            <div id="idFrontPreview" class="id-preview"></div>
                        </div>
                    </div>
                    
                    <div class="verification-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Kimlik Belgesinin Arka YÃ¼zÃ¼</div>
                            <div class="step-description">Kimlik kartÄ± veya ehliyet arka yÃ¼zÃ¼nÃ¼ yÃ¼kle</div>
                            <label class="file-upload-btn">
                                ğŸ“· FotoÄŸraf SeÃ§
                                <input type="file" accept="image/*" onchange="previewIDImage(event, 'back')" style="display: none;">
                            </label>
                            <div id="idBackPreview" class="id-preview"></div>
                        </div>
                    </div>
                    
                    <div class="verification-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Selfie</div>
                            <div class="step-description">KimliÄŸini tutarken bir selfie Ã§ek</div>
                            <label class="file-upload-btn">
                                ğŸ¤³ Selfie Ã‡ek
                                <input type="file" accept="image/*" capture="user" onchange="previewIDImage(event, 'selfie')" style="display: none;">
                            </label>
                            <div id="idSelfiePreview" class="id-preview"></div>
                        </div>
                    </div>
                </div>
                
                <div class="verification-note">
                    <strong>âš ï¸ Ã–nemli:</strong> Kimlik bilgilerin gÃ¼vende tutulacak ve sadece doÄŸrulama iÃ§in kullanÄ±lacaktÄ±r.
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button class="btn-primary" onclick="submitIDVerification()">ğŸ“¤ GÃ¶nder</button>
                    <button class="btn-secondary" onclick="closeModal('idVerificationModal')">Ä°ptal</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

let idImages = { front: null, back: null, selfie: null };

function previewIDImage(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        idImages[type] = e.target.result;
        const preview = document.getElementById(`id${type.charAt(0).toUpperCase() + type.slice(1)}Preview`);
        preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; border-radius: 8px;">`;
    };
    reader.readAsDataURL(file);
}

async function submitIDVerification() {
    if (!idImages.front || !idImages.back || !idImages.selfie) {
        alert('âŒ LÃ¼tfen tÃ¼m fotoÄŸraflarÄ± yÃ¼kle!');
        return;
    }
    
    try {
        // Backend'e kimlik doÄŸrulama isteÄŸi gÃ¶nder
        const response = await fetch('http://localhost:3000/api/submit-id-verification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: currentUserId || userProfile.telegram,
                userName: userProfile.firstName + ' ' + (userProfile.lastName || ''),
                images: idImages,
                submittedAt: Date.now()
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Eski red durumunu temizle
            userProfile.verificationPending = true;
            userProfile.verificationMethod = 'id';
            userProfile.verificationId = data.verificationId;
            userProfile.verificationSubmittedAt = Date.now();
            userProfile.verificationRejected = false;
            delete userProfile.rejectionReason;
            delete userProfile.rejectedAt;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            closeModal('idVerificationModal');
            addNotification('ğŸ“¤ Kimlik doÄŸrulama baÅŸvurun gÃ¶nderildi! Admin onayÄ± bekleniyor...');
            renderProfile();
        } else {
            alert('âŒ BaÅŸvuru gÃ¶nderilemedi. LÃ¼tfen tekrar dene.');
        }
    } catch (error) {
        console.error('ID verification error:', error);
        
        // Hata durumunda simÃ¼lasyon moduna geÃ§
        userProfile.verificationPending = true;
        userProfile.verificationMethod = 'id';
        userProfile.idImages = idImages;
        userProfile.verificationSubmittedAt = Date.now();
        userProfile.verificationRejected = false;
        delete userProfile.rejectionReason;
        delete userProfile.rejectedAt;
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        
        closeModal('idVerificationModal');
        addNotification('ğŸ“¤ Kimlik doÄŸrulama baÅŸvurun gÃ¶nderildi! Admin onayÄ± bekleniyor...');
        renderProfile();
    }
}

// 4. Payment Verification
function startPaymentVerification() {
    closeModal('verificationModal');
    
    const modal = `
        <div class="modal" id="paymentVerificationModal">
            <div class="modal-content">
                <h2>ğŸ’³ Ã–deme DoÄŸrulamasÄ±</h2>
                
                <div class="payment-info-box">
                    <div class="payment-amount">1 TL</div>
                    <div class="payment-description">Tek seferlik doÄŸrulama Ã¼creti</div>
                    <div class="payment-note">Bu Ã¼cret hesabÄ±na puan olarak yÃ¼klenecek</div>
                </div>
                
                <div class="verification-steps">
                    <div class="verification-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Ã–deme YÃ¶ntemi SeÃ§</div>
                            <div class="payment-methods">
                                <button class="payment-method-btn" onclick="selectPaymentMethod('card')">
                                    <span>ğŸ’³</span> Kredi KartÄ±
                                </button>
                                <button class="payment-method-btn" onclick="selectPaymentMethod('crypto')">
                                    <span>â‚¿</span> Kripto Para
                                </button>
                                <button class="payment-method-btn" onclick="selectPaymentMethod('papara')">
                                    <span>ğŸ’°</span> Papara
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="paymentFormContainer"></div>
                
                <button class="btn-secondary" onclick="closeModal('paymentVerificationModal')" style="margin-top: 16px;">Ä°ptal</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function selectPaymentMethod(method) {
    const container = document.getElementById('paymentFormContainer');
    
    if (method === 'card') {
        container.innerHTML = `
            <div class="payment-form">
                <h3>ğŸ’³ Kart Bilgileri</h3>
                <div id="card-element" style="background: #1a1d29; padding: 14px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.1);"></div>
                <div id="card-errors" style="color: #ff3b30; font-size: 13px; margin-top: 8px;"></div>
                <button class="btn-primary" onclick="processStripePayment()" style="width: 100%; margin-top: 16px;">
                    ğŸ’³ 1 TL Ã–de ve DoÄŸrula
                </button>
            </div>
        `;
        
        // Create Stripe card element
        if (typeof createCardElement === 'function') {
            setTimeout(() => {
                const cardElement = createCardElement('card-element');
                if (cardElement) {
                    cardElement.on('change', (event) => {
                        const displayError = document.getElementById('card-errors');
                        if (event.error) {
                            displayError.textContent = event.error.message;
                        } else {
                            displayError.textContent = '';
                        }
                    });
                    window.stripeCardElement = cardElement;
                }
            }, 100);
        }
    } else if (method === 'crypto') {
        container.innerHTML = `
            <div class="payment-form">
                <h3>â‚¿ Kripto Para ile Ã–deme</h3>
                <p style="text-align: center; color: #8b8d98;">AÅŸaÄŸÄ±daki adrese 1 TL deÄŸerinde kripto para gÃ¶nder:</p>
                <div class="crypto-address">
                    <code>0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb</code>
                    <button class="code-copy-btn" onclick="copyText('0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb')">ğŸ“‹</button>
                </div>
                <button class="btn-primary" onclick="processPayment('crypto')" style="width: 100%; margin-top: 16px;">
                    âœ“ Ã–demeyi YaptÄ±m
                </button>
            </div>
        `;
    } else if (method === 'papara') {
        container.innerHTML = `
            <div class="payment-form">
                <h3>ğŸ’° Papara ile Ã–deme</h3>
                <p style="text-align: center; color: #8b8d98;">Papara numarasÄ±na 1 TL gÃ¶nder:</p>
                <div class="crypto-address">
                    <code>1234567890</code>
                    <button class="code-copy-btn" onclick="copyText('1234567890')">ğŸ“‹</button>
                </div>
                <input type="text" class="verification-input" placeholder="GÃ¶nderen Papara NumarasÄ±" style="margin-top: 16px;">
                <button class="btn-primary" onclick="processPayment('papara')" style="width: 100%; margin-top: 16px;">
                    âœ“ Ã–demeyi YaptÄ±m
                </button>
            </div>
        `;
    }
}

async function processStripePayment() {
    if (!window.stripeCardElement) {
        alert('âŒ Kart bilgileri yÃ¼klenemedi!');
        return;
    }
    
    addNotification('â³ Ã–deme iÅŸleniyor...');
    
    try {
        // Create payment intent
        if (typeof createVerificationPayment === 'function') {
            const clientSecret = await createVerificationPayment(currentUserId, userProfile.email || '');
            
            if (clientSecret) {
                const result = await processCardPayment(window.stripeCardElement, clientSecret);
                
                if (result.success) {
                    userProfile.verified = true;
                    userProfile.verificationMethod = 'payment';
                    userProfile.verifiedAt = Date.now();
                    gameState.points += 100;
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    saveGame();
                    
                    closeModal('paymentVerificationModal');
                    addNotification('ğŸ‰ Ã–deme baÅŸarÄ±lÄ±! HesabÄ±n doÄŸrulandÄ± ve 100 puan kazandÄ±n!');
                    renderProfile();
                } else {
                    alert('âŒ Ã–deme baÅŸarÄ±sÄ±z: ' + result.error);
                }
            }
        } else {
            // Fallback to simulation
            processPayment('card');
        }
    } catch (error) {
        console.error('Payment error:', error);
        alert('âŒ Ã–deme hatasÄ±: ' + error.message);
    }
}

function copyText(text) {
    navigator.clipboard.writeText(text);
    addNotification('ğŸ“‹ KopyalandÄ±!');
}

function processPayment(method) {
    // SimÃ¼lasyon - gerÃ§ekte Ã¶deme iÅŸlemi yapÄ±lacak
    addNotification('â³ Ã–deme iÅŸleniyor...');
    
    setTimeout(() => {
        userProfile.verified = true;
        userProfile.verificationMethod = 'payment';
        userProfile.verifiedAt = Date.now();
        gameState.points += 100; // 1 TL = 100 puan
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        saveGame();
        
        closeModal('paymentVerificationModal');
        addNotification('ğŸ‰ Ã–deme baÅŸarÄ±lÄ±! HesabÄ±n doÄŸrulandÄ± ve 100 puan kazandÄ±n!');
        renderProfile();
    }, 2000);
}


// ============================================
// ADMIN: ID VERIFICATION APPROVALS
// ============================================

async function showIDVerificationApprovals() {
    try {
        // Backend'den bekleyen doÄŸrulama taleplerini al
        const response = await fetch('http://localhost:3000/api/get-pending-verifications');
        const data = await response.json();
        
        const pendingVerifications = data.verifications || [];
        
        const modal = `
            <div class="modal admin-modal" id="idApprovalsModal">
                <div class="admin-panel">
                    <div class="admin-header">
                        <h2>ğŸ‘‘ Kimlik DoÄŸrulama OnaylarÄ±</h2>
                        <button class="close-btn" onclick="closeModal('idApprovalsModal')">âœ•</button>
                    </div>
                    <div class="admin-content">
                        ${pendingVerifications.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #8b8d98;">
                                <div style="font-size: 48px; margin-bottom: 16px;">âœ…</div>
                                <div style="font-size: 18px; margin-bottom: 8px;">Bekleyen Talep Yok</div>
                                <div style="font-size: 14px;">TÃ¼m kimlik doÄŸrulama talepleri iÅŸlenmiÅŸ.</div>
                            </div>
                        ` : pendingVerifications.map(verification => `
                            <div class="verification-summary-card" onclick="showVerificationDetail('${verification.id}')" id="verification-${verification.id}">
                                <div class="verification-summary-header">
                                    <div class="verification-user-info">
                                        <div class="verification-avatar">ğŸ‘¤</div>
                                        <div>
                                            <div class="verification-name">${verification.userName}</div>
                                            <div class="verification-date">
                                                ${new Date(verification.submittedAt).toLocaleString('tr-TR')}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="verification-status-badge pending">â³ Bekliyor</div>
                                </div>
                                <div class="verification-summary-footer">
                                    <span style="color: #8b8d98; font-size: 12px;">DetaylarÄ± gÃ¶rmek iÃ§in tÄ±kla â†’</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // Store verifications data for detail view
        window.pendingVerifications = pendingVerifications;
    } catch (error) {
        console.error('Error loading verifications:', error);
        alert('âŒ DoÄŸrulama talepleri yÃ¼klenemedi.');
    }
}

function showVerificationDetail(verificationId) {
    const verification = window.pendingVerifications.find(v => v.id === verificationId);
    if (!verification) return;
    
    const modal = `
        <div class="modal" id="verificationDetailModal" style="z-index: 10001;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="verification-detail-header">
                    <h2>ğŸ“¸ Kimlik DoÄŸrulama DetayÄ±</h2>
                    <button class="close-btn" onclick="closeModal('verificationDetailModal')">âœ•</button>
                </div>
                
                <div class="verification-detail-user">
                    <div class="verification-avatar" style="width: 64px; height: 64px; font-size: 32px;">ğŸ‘¤</div>
                    <div>
                        <div class="verification-name" style="font-size: 20px;">${verification.userName}</div>
                        <div class="verification-date">${new Date(verification.submittedAt).toLocaleString('tr-TR')}</div>
                    </div>
                </div>
                
                <div class="verification-images">
                    <div class="verification-image-item">
                        <div class="verification-image-label">Ã–n YÃ¼z</div>
                        <img src="${verification.images.front}" onclick="viewFullImage('${verification.images.front}')" class="verification-img">
                    </div>
                    <div class="verification-image-item">
                        <div class="verification-image-label">Arka YÃ¼z</div>
                        <img src="${verification.images.back}" onclick="viewFullImage('${verification.images.back}')" class="verification-img">
                    </div>
                    <div class="verification-image-item">
                        <div class="verification-image-label">Selfie</div>
                        <img src="${verification.images.selfie}" onclick="viewFullImage('${verification.images.selfie}')" class="verification-img">
                    </div>
                </div>
                
                <div class="verification-actions">
                    <button class="btn-approve" onclick="approveVerification('${verification.id}', '${verification.userId}')">
                        âœ… Onayla
                    </button>
                    <button class="btn-reject" onclick="showRejectReason('${verification.id}', '${verification.userId}')">
                        âŒ Reddet
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function viewFullImage(imageSrc) {
    const modal = `
        <div class="modal" id="imageViewModal" onclick="closeModal('imageViewModal')" style="background: rgba(0,0,0,0.95);">
            <div class="modal-content" style="max-width: 90vw; max-height: 90vh; background: transparent; padding: 0;">
                <img src="${imageSrc}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

async function approveVerification(verificationId, userId) {
    if (!confirm('Bu kimlik doÄŸrulamasÄ±nÄ± onaylamak istediÄŸinden emin misin?')) return;
    
    try {
        const response = await fetch('http://localhost:3000/api/approve-id-verification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                verificationId: verificationId,
                userId: userId,
                approved: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ModallarÄ± kapat
            closeModal('verificationDetailModal');
            
            // KartÄ± kaldÄ±r
            const card = document.getElementById(`verification-${verificationId}`);
            if (card) {
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                setTimeout(() => card.remove(), 300);
            }
            
            addNotification('âœ… Kimlik doÄŸrulamasÄ± onaylandÄ±!');
            
            // EÄŸer onaylanan kullanÄ±cÄ± ÅŸu anki kullanÄ±cÄ±ysa, profilini gÃ¼ncelle
            if (userId === (currentUserId || userProfile.telegram).toString()) {
                userProfile.verified = true;
                userProfile.verificationPending = false;
                userProfile.verifiedAt = Date.now();
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                renderProfile();
            }
            
            // EÄŸer baÅŸka talep yoksa ana modalÄ± kapat
            setTimeout(() => {
                const remainingCards = document.querySelectorAll('.verification-summary-card');
                if (remainingCards.length === 0) {
                    closeModal('idApprovalsModal');
                }
            }, 500);
        } else {
            alert('âŒ Onaylama iÅŸlemi baÅŸarÄ±sÄ±z oldu.');
        }
    } catch (error) {
        console.error('Approval error:', error);
        alert('âŒ Bir hata oluÅŸtu. LÃ¼tfen tekrar dene.');
    }
}

function showRejectReason(verificationId, userId) {
    const modal = `
        <div class="modal" id="rejectReasonModal" style="z-index: 10002;">
            <div class="modal-content" style="max-width: 500px;">
                <h2>âŒ Reddetme Sebebi</h2>
                <p style="color: #8b8d98; margin-bottom: 20px;">LÃ¼tfen kimlik doÄŸrulamasÄ±nÄ± neden reddettiÄŸinizi belirtin:</p>
                
                <textarea id="rejectReasonText" class="input-field" placeholder="Reddetme sebebini yaz..." style="min-height: 120px; resize: vertical;"></textarea>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-reject" onclick="confirmRejectVerification('${verificationId}', '${userId}')">
                        âŒ Reddet
                    </button>
                    <button class="btn-secondary" onclick="closeModal('rejectReasonModal')">
                        Ä°ptal
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

async function confirmRejectVerification(verificationId, userId) {
    const reason = document.getElementById('rejectReasonText').value.trim();
    
    if (!reason) {
        alert('âŒ LÃ¼tfen reddetme sebebini yazÄ±n!');
        return;
    }
    
    try {
        const response = await fetch('http://localhost:3000/api/approve-id-verification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                verificationId: verificationId,
                userId: userId,
                approved: false,
                reason: reason
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ModallarÄ± kapat
            closeModal('rejectReasonModal');
            closeModal('verificationDetailModal');
            
            // KartÄ± kaldÄ±r
            const card = document.getElementById(`verification-${verificationId}`);
            if (card) {
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                setTimeout(() => card.remove(), 300);
            }
            
            addNotification('âŒ Kimlik doÄŸrulamasÄ± reddedildi.');
            
            // EÄŸer reddedilen kullanÄ±cÄ± ÅŸu anki kullanÄ±cÄ±ysa, profilini gÃ¼ncelle
            if (userId === (currentUserId || userProfile.telegram).toString()) {
                userProfile.verified = false;
                userProfile.verificationPending = false;
                userProfile.verificationRejected = true;
                userProfile.rejectionReason = reason;
                userProfile.rejectedAt = Date.now();
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                renderProfile();
            }
            
            // EÄŸer baÅŸka talep yoksa ana modalÄ± kapat
            setTimeout(() => {
                const remainingCards = document.querySelectorAll('.verification-summary-card');
                if (remainingCards.length === 0) {
                    closeModal('idApprovalsModal');
                }
            }, 500);
        } else {
            alert('âŒ Reddetme iÅŸlemi baÅŸarÄ±sÄ±z oldu.');
        }
    } catch (error) {
        console.error('Rejection error:', error);
        alert('âŒ Bir hata oluÅŸtu. LÃ¼tfen tekrar dene.');
    }
}

async function rejectVerification(verificationId, userId) {
    showRejectReason(verificationId, userId);
}


// Test iÃ§in localStorage temizleme fonksiyonu (geliÅŸtirme aÅŸamasÄ±nda kullan)
function resetVerificationStatus() {
    if (userProfile) {
        userProfile.verified = false;
        userProfile.verificationPending = false;
        userProfile.verificationMethod = null;
        userProfile.verifiedAt = null;
        userProfile.verificationId = null;
        delete userProfile.idImages;
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        renderProfile();
        addNotification('ğŸ”„ DoÄŸrulama durumu sÄ±fÄ±rlandÄ±!');
    }
}

// Console'dan Ã§aÄŸÄ±rmak iÃ§in: resetVerificationStatus()


// Close registration form
function closeRegistrationForm() {
    const regForm = document.getElementById('registrationForm');
    if (regForm) {
        regForm.remove();
    }
}
